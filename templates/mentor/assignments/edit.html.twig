{% extends 'mentor/base.html.twig' %}

{% form_theme form 'form/collection_widget.html.twig' %}

{% block body %}
    <div class="page-header d-print-none">
        <div class="container-xl">
            <div class="row g-2 align-items-center">
                <div class="col">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ path('mentor_assignments_index') }}">Assignations</a></li>
                            <li class="breadcrumb-item"><a href="{{ path('mentor_assignments_show', {id: assignment.id}) }}">{{ assignment.mission.title }}</a></li>
                            <li class="breadcrumb-item active">Modifier</li>
                        </ol>
                    </nav>
                    <h2 class="page-title">{{ page_title }}</h2>
                    <div class="page-subtitle">
                        Modifier l'assignation de {{ assignment.student.firstName }} {{ assignment.student.lastName }}
                    </div>
                </div>
                <div class="col-auto ms-auto d-print-none">
                    <div class="btn-list">
                        <a href="{{ path('mentor_assignments_show', {id: assignment.id}) }}" class="btn btn-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                <path d="M5 12l14 0"/>
                                <path d="M5 12l6 6"/>
                                <path d="M5 12l6 -6"/>
                            </svg>
                            Retour
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-xl">
        <div class="row row-deck row-cards">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Informations de l'assignation</h3>
                    </div>
                    {{ form_start(form, {attr: {novalidate: 'novalidate'}}) }}
                        <div class="card-body">
                            <!-- Mission Selection (readonly for edit) -->
                            <div class="mb-3">
                                {{ form_label(form.mission, null, {label_attr: {class: 'form-label'}}) }}
                                <div class="form-control-plaintext bg-light p-2 border rounded">
                                    {{ assignment.mission.title }}
                                </div>
                                {{ form_widget(form.mission, {attr: {style: 'display: none;'}}) }}
                                {{ form_errors(form.mission) }}
                                <small class="form-hint">La mission ne peut pas être modifiée après création</small>
                            </div>

                            <!-- Student Selection (readonly for edit) -->
                            <div class="mb-3">
                                {{ form_label(form.student, null, {label_attr: {class: 'form-label'}}) }}
                                <div class="form-control-plaintext bg-light p-2 border rounded">
                                    {{ assignment.student.firstName }} {{ assignment.student.lastName }}
                                </div>
                                {{ form_widget(form.student, {attr: {style: 'display: none;'}}) }}
                                {{ form_errors(form.student) }}
                                <small class="form-hint">L'alternant ne peut pas être modifié après création</small>
                            </div>

                            <!-- Dates -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form_label(form.startDate, null, {label_attr: {class: 'form-label required'}}) }}
                                        {{ form_widget(form.startDate, {attr: {class: 'form-control'}}) }}
                                        {{ form_errors(form.startDate) }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form_label(form.endDate, null, {label_attr: {class: 'form-label'}}) }}
                                        {{ form_widget(form.endDate, {attr: {class: 'form-control'}}) }}
                                        {{ form_errors(form.endDate) }}
                                    </div>
                                </div>
                            </div>

                            <!-- Status -->
                            <div class="mb-3">
                                {{ form_label(form.status, null, {label_attr: {class: 'form-label'}}) }}
                                {{ form_widget(form.status, {attr: {class: 'form-select'}}) }}
                                {{ form_errors(form.status) }}
                            </div>

                            <!-- Intermediate Objectives -->
                            <div class="mb-3">
                                {{ form_label(form.intermediateObjectivesForForm, null, {label_attr: {class: 'form-label'}}) }}
                                {{ form_widget(form.intermediateObjectivesForForm) }}
                                {{ form_errors(form.intermediateObjectivesForForm) }}
                                <small class="form-hint">Objectifs intermédiaires pour cette assignation</small>
                            </div>

                            <!-- Completion Rate -->
                            <div class="mb-3">
                                {{ form_label(form.completionRate, null, {label_attr: {class: 'form-label'}}) }}
                                {{ form_widget(form.completionRate, {attr: {class: 'form-control'}}) }}
                                {{ form_errors(form.completionRate) }}
                                <small class="form-hint">{{ form.completionRate.vars.help }}</small>
                            </div>

                            <!-- Difficulties -->
                            <div class="mb-3">
                                {{ form_label(form.difficulties, null, {label_attr: {class: 'form-label'}}) }}
                                {{ form_widget(form.difficulties) }}
                                {{ form_errors(form.difficulties) }}
                            </div>

                            <!-- Achievements -->
                            <div class="mb-3">
                                {{ form_label(form.achievements, null, {label_attr: {class: 'form-label'}}) }}
                                {{ form_widget(form.achievements) }}
                                {{ form_errors(form.achievements) }}
                            </div>

                            <!-- Mentor Feedback -->
                            <div class="mb-3">
                                {{ form_label(form.mentorFeedback, null, {label_attr: {class: 'form-label'}}) }}
                                {{ form_widget(form.mentorFeedback, {attr: {class: 'form-control'}}) }}
                                {{ form_errors(form.mentorFeedback) }}
                            </div>

                            <!-- Student Feedback -->
                            <div class="mb-3">
                                {{ form_label(form.studentFeedback, null, {label_attr: {class: 'form-label'}}) }}
                                {{ form_widget(form.studentFeedback, {attr: {class: 'form-control'}}) }}
                                {{ form_errors(form.studentFeedback) }}
                            </div>

                            <!-- Ratings -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form_label(form.mentorRating, null, {label_attr: {class: 'form-label'}}) }}
                                        {{ form_widget(form.mentorRating, {attr: {class: 'form-select'}}) }}
                                        {{ form_errors(form.mentorRating) }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form_label(form.studentSatisfaction, null, {label_attr: {class: 'form-label'}}) }}
                                        {{ form_widget(form.studentSatisfaction, {attr: {class: 'form-select'}}) }}
                                        {{ form_errors(form.studentSatisfaction) }}
                                    </div>
                                </div>
                            </div>

                            <!-- Competencies Acquired -->
                            <div class="mb-3">
                                {{ form_label(form.competenciesAcquired, null, {label_attr: {class: 'form-label'}}) }}
                                {{ form_widget(form.competenciesAcquired) }}
                                {{ form_errors(form.competenciesAcquired) }}
                            </div>
                        </div>

                        <div class="card-footer text-end">
                            <div class="d-flex">
                                <a href="{{ path('mentor_assignments_show', {id: assignment.id}) }}" class="btn btn-link">Annuler</a>
                                <button type="submit" class="btn btn-primary ms-auto">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                        <path d="M12 5l0 14"/>
                                        <path d="M5 12l14 0"/>
                                    </svg>
                                    Modifier l'assignation
                                </button>
                            </div>
                        </div>
                        
                        {# Mark fields as rendered to prevent duplication in form_end() #}
                        {% do form.mission.setRendered %}
                        {% do form.student.setRendered %}
                        {% do form.startDate.setRendered %}
                        {% do form.endDate.setRendered %}
                        {% do form.status.setRendered %}
                        {% do form.intermediateObjectivesForForm.setRendered %}
                        {% do form.completionRate.setRendered %}
                        {% do form.difficulties.setRendered %}
                        {% do form.achievements.setRendered %}
                        {% do form.mentorFeedback.setRendered %}
                        {% do form.studentFeedback.setRendered %}
                        {% do form.mentorRating.setRendered %}
                        {% do form.studentSatisfaction.setRendered %}
                        {% do form.competenciesAcquired.setRendered %}
                        
                    {{ form_end(form) }}
                </div>
            </div>

            <!-- Help Panel -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Guide de modification</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h4 class="card-title h5">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon text-warning me-2" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M12 9v2m0 4v.01"/>
                                    <path d="M5 19h14a2 2 0 0 0 1.84 -1.16l7 -12a2 2 0 0 0 0 -1.68l-7 -12a2 2 0 0 0 -1.84 -1.16h-14a2 2 0 0 0 -1.84 1.16l-7 12a2 2 0 0 0 0 1.68l7 12a2 2 0 0 0 1.84 1.16z"/>
                                </svg>
                                Éléments non modifiables
                            </h4>
                            <p class="text-muted">La mission et l'alternant ne peuvent pas être modifiés après la création de l'assignation.</p>
                        </div>

                        <div class="mb-3">
                            <h4 class="card-title h5">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon text-success me-2" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M7 10l5 5l5 -5"/>
                                    <path d="M21 10l-2 2l-2 -2"/>
                                </svg>
                                Mise à jour du suivi
                            </h4>
                            <p class="text-muted">Vous pouvez modifier le statut, l'avancement, les objectifs et ajouter des commentaires.</p>
                        </div>

                        <div class="mb-3">
                            <h4 class="card-title h5">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon text-primary me-2" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M9 12l2 2l4 -4"/>
                                    <path d="M21 12c0 .5 -.1 1 -.3 1.5"/>
                                </svg>
                                Évaluation
                            </h4>
                            <p class="text-muted">N'oubliez pas de mettre à jour les évaluations et les compétences acquises au fur et à mesure de l'avancement.</p>
                        </div>

                        <div class="alert alert-info">
                            <h4 class="alert-title">Conseil</h4>
                            <div class="text-muted">Documentez régulièrement l'évolution de l'assignation pour faciliter le suivi et l'évaluation finale.</div>
                        </div>
                    </div>
                </div>

                <!-- Assignment Progress Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Informations de l'assignation</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-6">
                                    <strong>Mission:</strong>
                                </div>
                                <div class="col-6">
                                    {{ assignment.mission.title }}
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-6">
                                    <strong>Alternant:</strong>
                                </div>
                                <div class="col-6">
                                    {{ assignment.student.firstName }} {{ assignment.student.lastName }}
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-6">
                                    <strong>Statut actuel:</strong>
                                </div>
                                <div class="col-6">
                                    <span class="badge badge-outline text-{{ assignment.status == 'planifiee' ? 'blue' : (assignment.status == 'en_cours' ? 'orange' : (assignment.status == 'terminee' ? 'green' : 'red')) }}">
                                        {{ assignment.status|replace({'_': ' '})|title }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% if assignment.completionRate is not null %}
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-6">
                                    <strong>Avancement:</strong>
                                </div>
                                <div class="col-6">
                                    {{ assignment.completionRate }}%
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
