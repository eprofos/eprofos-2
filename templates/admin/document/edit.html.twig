{% extends 'admin/base.html.twig' %}

{% block title %}Modifier {{ document.title }} - Administration{% endblock %}

{% block page_actions %}
    <div class="btn-list">
        <a href="{{ path('admin_document_show', {'id': document.id}) }}" class="btn btn-outline-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0"/>
                <path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6"/>
            </svg>
            Voir le document
        </a>
    </div>
{% endblock %}

{% block body %}
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Modifier le document</h3>
                    <div class="card-actions">
                        {% set status_class = {
                            'draft': 'secondary',
                            'review': 'warning',
                            'approved': 'info',
                            'published': 'success',
                            'archived': 'dark',
                            'expired': 'danger'
                        } %}
                        <span class="badge bg-{{ status_class[document.status] ?? 'secondary' }}">
                            {{ constant('App\\Entity\\Document\\Document::STATUSES')[document.status] ?? document.status }}
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    {{ form_start(form, {'attr': {'novalidate': 'novalidate', 'data-document-form': 'true'}}) }}
                    
                    <div class="row">
                        <div class="col-lg-8">
                            <!-- Main Content -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h4 class="card-title">Contenu principal</h4>
                                    <div class="card-actions">
                                        <small class="text-muted">
                                            Dernière modification : {{ document.updatedAt|date('d/m/Y à H:i') }}
                                            {% if document.updatedBy %}
                                                par {{ document.updatedBy.firstName }} {{ document.updatedBy.lastName }}
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        {{ form_label(form.title) }}
                                        {{ form_widget(form.title) }}
                                        {{ form_errors(form.title) }}
                                        {{ form_help(form.title) }}
                                    </div>

                                    <div class="mb-3">
                                        {{ form_label(form.slug) }}
                                        {{ form_widget(form.slug) }}
                                        {{ form_errors(form.slug) }}
                                        {{ form_help(form.slug) }}
                                        <div class="form-text">
                                            URL publique : <code>{{ app.request.getSchemeAndHttpHost() }}/documents/{{ document.slug }}</code>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        {{ form_label(form.description) }}
                                        {{ form_widget(form.description) }}
                                        {{ form_errors(form.description) }}
                                        {{ form_help(form.description) }}
                                    </div>

                                    <div class="mb-3">
                                        {{ form_label(form.content) }}
                                        {{ form_widget(form.content) }}
                                        {{ form_errors(form.content) }}
                                        {{ form_help(form.content) }}
                                    </div>
                                </div>
                            </div>

                            <!-- Version Information -->
                            {% if document.versions|length > 0 %}
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h4 class="card-title">Version actuelle</h4>
                                    </div>
                                    <div class="card-body">
                                        {% set currentVersion = document.versions|filter(v => v.isCurrent)|first %}
                                        {% if currentVersion %}
                                            <div class="row">
                                                <div class="col-sm-6">
                                                    <div class="mb-2">
                                                        <strong>Version :</strong> v{{ currentVersion.version }}
                                                    </div>
                                                    <div class="mb-2">
                                                        <strong>Créée le :</strong> {{ currentVersion.createdAt|date('d/m/Y à H:i') }}
                                                    </div>
                                                </div>
                                                <div class="col-sm-6">
                                                    {% if currentVersion.createdBy %}
                                                        <div class="mb-2">
                                                            <strong>Par :</strong> {{ currentVersion.createdBy.firstName }} {{ currentVersion.createdBy.lastName }}
                                                        </div>
                                                    {% endif %}
                                                    {% if currentVersion.changeLog %}
                                                        <div class="mb-2">
                                                            <strong>Modifications :</strong> {{ currentVersion.changeLog }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="alert alert-info">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                    <path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0"/>
                                                    <path d="M12 9h.01"/>
                                                    <path d="M11 12h1v4h1"/>
                                                </svg>
                                                <div>
                                                    <h4 class="alert-title">Gestion des versions</h4>
                                                    <div class="text-muted">Utilisez les options de gestion des versions dans la section "Gestion des versions" pour contrôler la création de nouvelles versions.</div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}

                            <!-- Dynamic Metadata Fields -->
                            {% set hasMetadataFields = false %}
                            {% for field_name, field in form %}
                                {% if field_name starts with 'meta_' %}
                                    {% set hasMetadataFields = true %}
                                {% endif %}
                            {% endfor %}

                            {% if hasMetadataFields %}
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h4 class="card-title">Métadonnées personnalisées</h4>
                                    </div>
                                    <div class="card-body">
                                        {% for field_name, field in form %}
                                            {% if field_name starts with 'meta_' %}
                                                <div class="mb-3">
                                                    {{ form_label(field) }}
                                                    {{ form_widget(field) }}
                                                    {{ form_errors(field) }}
                                                    {{ form_help(field) }}
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-lg-4">
                            <!-- Publication Settings -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h4 class="card-title">Paramètres de publication</h4>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        {{ form_label(form.documentType) }}
                                        {{ form_widget(form.documentType) }}
                                        {{ form_errors(form.documentType) }}
                                        {{ form_help(form.documentType) }}
                                    </div>

                                    <div class="mb-3">
                                        {{ form_label(form.category) }}
                                        {{ form_widget(form.category) }}
                                        {{ form_errors(form.category) }}
                                        {{ form_help(form.category) }}
                                    </div>

                                    <div class="mb-3">
                                        {{ form_label(form.status) }}
                                        {{ form_widget(form.status) }}
                                        {{ form_errors(form.status) }}
                                        {{ form_help(form.status) }}
                                        
                                        {% if document.documentType and not document.documentType.isAllowMultiplePublished and document.status == 'published' %}
                                            <div class="form-text text-warning">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                    <path d="M12 9v2m0 4v.01"/>
                                                    <path d="M5 19h14a2 2 0 0 0 1.84 -2.75l-7.1 -12.25a2 2 0 0 0 -3.5 0l-7.1 12.25a2 2 0 0 0 1.75 2.75"/>
                                                </svg>
                                                Ce type de document ne permet qu'un seul document publié à la fois.
                                            </div>
                                        {% endif %}
                                    </div>

                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-check form-switch">
                                                {{ form_widget(form.isActive) }}
                                                {{ form_label(form.isActive, null, {'label_attr': {'class': 'form-check-label'}}) }}
                                                {{ form_errors(form.isActive) }}
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-check form-switch">
                                                {{ form_widget(form.isPublic) }}
                                                {{ form_label(form.isPublic, null, {'label_attr': {'class': 'form-check-label'}}) }}
                                                {{ form_errors(form.isPublic) }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Document Information -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h4 class="card-title">Informations</h4>
                                </div>
                                <div class="card-body">
                                    <div class="datagrid">
                                        <div class="datagrid-item">
                                            <div class="datagrid-title">ID</div>
                                            <div class="datagrid-content"><code>#{{ document.id }}</code></div>
                                        </div>
                                        <div class="datagrid-item">
                                            <div class="datagrid-title">Créé le</div>
                                            <div class="datagrid-content">{{ document.createdAt|date('d/m/Y à H:i') }}</div>
                                        </div>
                                        <div class="datagrid-item">
                                            <div class="datagrid-title">Modifié le</div>
                                            <div class="datagrid-content">{{ document.updatedAt|date('d/m/Y à H:i') }}</div>
                                        </div>
                                        {% if document.publishedAt %}
                                            <div class="datagrid-item">
                                                <div class="datagrid-title">Publié le</div>
                                                <div class="datagrid-content">{{ document.publishedAt|date('d/m/Y à H:i') }}</div>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Options -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h4 class="card-title">Options avancées</h4>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        {{ form_label(form.tags) }}
                                        {{ form_widget(form.tags) }}
                                        {{ form_errors(form.tags) }}
                                        {{ form_help(form.tags) }}
                                    </div>

                                    {% if form.expiresAt is defined %}
                                        <div class="mb-3">
                                            {{ form_label(form.expiresAt) }}
                                            {{ form_widget(form.expiresAt) }}
                                            {{ form_errors(form.expiresAt) }}
                                            {{ form_help(form.expiresAt) }}
                                            
                                            {% if document.isExpired %}
                                                <div class="form-text text-danger">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                        <path d="M12 9v2m0 4v.01"/>
                                                        <path d="M5 19h14a2 2 0 0 0 1.84 -2.75l-7.1 -12.25a2 2 0 0 0 -3.5 0l-7.1 12.25a2 2 0 0 0 1.75 2.75"/>
                                                    </svg>
                                                    Ce document a expiré.
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Version Management -->
                            {% if form.versionType is defined and form.versionMessage is defined %}
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h4 class="card-title">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <path d="M3 12a9 9 0 0 1 9 -9a9.75 9.75 0 0 1 6.74 2.74l-1.132 1.132a8.25 8.25 0 0 0 -5.608 -2.372a7.5 7.5 0 0 0 -7.5 7.5"/>
                                                <path d="M21 12a9 9 0 0 1 -9 9a9.75 9.75 0 0 1 -6.74 -2.74l1.132 -1.132a8.25 8.25 0 0 0 5.608 2.372a7.5 7.5 0 0 0 7.5 -7.5"/>
                                                <path d="M12 7v5l3 3"/>
                                            </svg>
                                            Gestion des versions
                                        </h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="alert alert-info">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0"/>
                                                <path d="M12 9h.01"/>
                                                <path d="M11 12h1v4h1"/>
                                            </svg>
                                            <div>
                                                <h4 class="alert-title">Contrôle des versions</h4>
                                                <div class="text-muted">
                                                    Choisissez si cette modification doit créer une nouvelle version et décrivez les changements apportés.
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            {{ form_label(form.versionType) }}
                                            {{ form_widget(form.versionType) }}
                                            {{ form_errors(form.versionType) }}
                                            {{ form_help(form.versionType) }}
                                        </div>

                                        <div class="mb-3" id="version-message-container">
                                            {{ form_label(form.versionMessage) }}
                                            {{ form_widget(form.versionMessage) }}
                                            {{ form_errors(form.versionMessage) }}
                                            {{ form_help(form.versionMessage) }}
                                            
                                            <div class="form-text">
                                                <small class="text-muted">
                                                    <strong>Exemples :</strong><br>
                                                    • <em>Correction des fautes de frappe et mise à jour des liens</em> (modification mineure)<br>
                                                    • <em>Ajout de nouvelles procédures et révision complète du contenu</em> (modification majeure)<br>
                                                    • <em>Correction de formatage uniquement</em> (pas de nouvelle version)
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <!-- Actions -->
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button type="submit" name="action" value="save" class="btn btn-primary">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <path d="M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2"/>
                                                <path d="M12 14m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"/>
                                                <path d="M14 4l0 4l-6 0l0 -4"/>
                                            </svg>
                                            Enregistrer les modifications
                                        </button>
                                        
                                        {% if document.status != 'published' %}
                                            <button type="submit" name="action" value="save_and_publish" class="btn btn-success">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                    <path d="M5 12l5 5l10 -10"/>
                                                </svg>
                                                Enregistrer et publier
                                            </button>
                                        {% endif %}
                                        
                                        <a href="{{ path('admin_document_show', {'id': document.id}) }}" class="btn btn-outline-primary">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0"/>
                                                <path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6"/>
                                            </svg>
                                            Voir le document
                                        </a>
                                        
                                        <a href="{{ path('admin_document_index') }}" class="btn btn-outline-secondary">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <path d="M9 11l-4 4l4 4m-4 -4h11a4 4 0 0 0 0 -8h-1"/>
                                            </svg>
                                            Retour à la liste
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {{ form_rest(form) }}
                    {{ form_end(form) }}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-generate slug from title (only if slug is empty)
            const titleField = document.getElementById('document_title');
            const slugField = document.getElementById('document_slug');
            
            if (titleField && slugField) {
                titleField.addEventListener('input', function() {
                    if (!slugField.value.trim()) {
                        const slug = this.value
                            .toLowerCase()
                            .replace(/[^a-z0-9]+/g, '-')
                            .replace(/^-+|-+$/g, '');
                        
                        slugField.value = slug;
                    }
                });
            }

            // Initialize rich text editor if present
            const editorField = document.querySelector('[data-editor="true"]');
            if (editorField && typeof tinymce !== 'undefined') {
                tinymce.init({
                    target: editorField,
                    height: 400,
                    menubar: false,
                    plugins: [
                        'advlist', 'autolink', 'lists', 'link', 'image', 'charmap',
                        'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                        'insertdatetime', 'media', 'table', 'help', 'wordcount'
                    ],
                    toolbar: 'undo redo | blocks | ' +
                        'bold italic backcolor | alignleft aligncenter ' +
                        'alignright alignjustify | bullist numlist outdent indent | ' +
                        'removeformat | help',
                    content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, San Francisco, Segoe UI, Roboto, Helvetica Neue, sans-serif; font-size: 14px }'
                });
            }

            // Initialize tags input if present
            const tagsField = document.querySelector('[data-tags="true"]');
            if (tagsField) {
                tagsField.addEventListener('input', function() {
                    const value = this.value;
                    if (value && !value.match(/^[\w\s,]+$/)) {
                        this.setCustomValidity('Les tags ne peuvent contenir que des lettres, chiffres, espaces et virgules.');
                    } else {
                        this.setCustomValidity('');
                    }
                });
            }

            // Handle save and publish action
            const saveAndPublishBtn = document.querySelector('[name="action"][value="save_and_publish"]');
            if (saveAndPublishBtn) {
                saveAndPublishBtn.addEventListener('click', function(e) {
                    const statusField = document.getElementById('document_status');
                    if (statusField && statusField.value !== 'published') {
                        const confirmed = confirm('Cela va changer le statut du document en "Publié". Continuer ?');
                        if (!confirmed) {
                            e.preventDefault();
                            return false;
                        }
                        statusField.value = 'published';
                    }
                });
            }

            // Document type change handler
            const documentTypeField = document.getElementById('document_documentType');
            if (documentTypeField) {
                documentTypeField.addEventListener('change', function() {
                    console.log('Document type changed to:', this.value);
                    // In a real implementation, you might want to make an AJAX call
                    // to get type-specific fields or validation rules
                });
            }

            // Version management handlers
            const versionTypeRadios = document.querySelectorAll('[name="document[versionType]"]');
            const versionMessageContainer = document.getElementById('version-message-container');
            const versionMessageField = document.getElementById('document_versionMessage');

            function updateVersionMessageRequirement() {
                const selectedType = document.querySelector('[name="document[versionType]"]:checked');
                if (selectedType && versionMessageContainer && versionMessageField) {
                    if (selectedType.value === 'none') {
                        versionMessageContainer.style.display = 'none';
                        versionMessageField.required = false;
                        versionMessageField.value = '';
                    } else {
                        versionMessageContainer.style.display = 'block';
                        versionMessageField.required = true;
                    }
                }
            }

            // Initialize version management
            if (versionTypeRadios.length > 0) {
                updateVersionMessageRequirement();
                
                versionTypeRadios.forEach(radio => {
                    radio.addEventListener('change', updateVersionMessageRequirement);
                });
            }

            // Form validation for version management
            const documentForm = document.querySelector('[data-document-form="true"]');
            if (documentForm) {
                documentForm.addEventListener('submit', function(e) {
                    const selectedType = document.querySelector('[name="document[versionType]"]:checked');
                    const versionMessage = document.getElementById('document_versionMessage');
                    
                    if (selectedType && versionMessage) {
                        if (selectedType.value !== 'none' && !versionMessage.value.trim()) {
                            e.preventDefault();
                            alert('Un message de version est obligatoire pour créer une nouvelle version.');
                            versionMessage.focus();
                            return false;
                        }
                    }
                });
            }
        });
    </script>
{% endblock %}
