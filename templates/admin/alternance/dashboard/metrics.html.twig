{% extends 'admin/base.html.twig' %}

{% block title %}Métriques Détaillées - Alternance{% endblock %}

{% block page_header %}
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="h2 mb-1">Métriques Détaillées</h1>
            <p class="text-muted mb-0">Analyse approfondie des performances d'alternance</p>
        </div>
        <div class="btn-toolbar" role="toolbar">
            <div class="btn-group me-2">
                <a href="{{ path('admin_alternance_dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Retour au Tableau de Bord
                </a>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-download me-2"></i>Exporter
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="exportToExcel()">Excel</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportToPDF()">PDF</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportToCSV()">CSV</a></li>
                </ul>
            </div>
        </div>
    </div>
{% endblock %}

{% block body %}
    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label for="period" class="form-label">Période</label>
                            <select name="period" id="period" class="form-select">
                                <option value="7" {{ period == '7' ? 'selected' : '' }}>7 derniers jours</option>
                                <option value="30" {{ period == '30' ? 'selected' : '' }}>30 derniers jours</option>
                                <option value="90" {{ period == '90' ? 'selected' : '' }}>3 derniers mois</option>
                                <option value="365" {{ period == '365' ? 'selected' : '' }}>12 derniers mois</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="formation" class="form-label">Formation</label>
                            <select name="formation" id="formation" class="form-select">
                                <option value="">Toutes les formations</option>
                                {# Add formation options here when formations are available #}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="status" class="form-label">Statut</label>
                            <select name="status" id="status" class="form-select">
                                <option value="">Tous les statuts</option>
                                <option value="active">Actifs</option>
                                <option value="completed">Terminés</option>
                                <option value="suspended">Suspendus</option>
                                <option value="cancelled">Annulés</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-filter me-2"></i>Filtrer
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Performance Indicators -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">Indicateurs Clés de Performance</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-3 col-sm-6 mb-3">
                            <div class="text-center p-3 border rounded">
                                <h3 class="text-primary mb-1">{{ metrics.contracts_created }}</h3>
                                <p class="text-muted mb-0">Contrats Créés</p>
                            </div>
                        </div>
                        <div class="col-lg-3 col-sm-6 mb-3">
                            <div class="text-center p-3 border rounded">
                                <h3 class="text-success mb-1">{{ metrics.contracts_completed }}</h3>
                                <p class="text-muted mb-0">Contrats Terminés</p>
                            </div>
                        </div>
                        <div class="col-lg-3 col-sm-6 mb-3">
                            <div class="text-center p-3 border rounded">
                                <h3 class="text-info mb-1">{{ ((metrics.contracts_completed / metrics.contracts_created) * 100)|number_format(1) }}%</h3>
                                <p class="text-muted mb-0">Taux de Finalisation</p>
                            </div>
                        </div>
                        <div class="col-lg-3 col-sm-6 mb-3">
                            <div class="text-center p-3 border rounded">
                                <h3 class="text-warning mb-1">{{ metrics.risk_analysis.high_risk_contracts }}</h3>
                                <p class="text-muted mb-0">Contrats à Risque</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Rate by Formation -->
    {% if metrics.success_by_formation|length > 0 %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom">
                        <h5 class="card-title mb-0">Taux de Réussite par Formation</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Formation</th>
                                        <th>Total Contrats</th>
                                        <th>Contrats Réussis</th>
                                        <th>Taux de Réussite</th>
                                        <th>Durée Moyenne</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for formation_data in metrics.success_by_formation %}
                                        <tr>
                                            <td>
                                                <strong>{{ formation_data.formation_name }}</strong>
                                            </td>
                                            <td>{{ formation_data.total_contracts }}</td>
                                            <td>{{ formation_data.successful_contracts }}</td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="me-2">{{ formation_data.success_rate }}%</span>
                                                    <div class="progress flex-grow-1" style="height: 6px;">
                                                        <div class="progress-bar bg-success" style="width: {{ formation_data.success_rate }}%"></div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>{{ formation_data.average_duration }} mois</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Duration Analysis -->
    <div class="row mb-4">
        <div class="col-lg-8 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">Analyse des Durées</h5>
                </div>
                <div class="card-body">
                    <canvas id="durationAnalysisChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">Répartition des Durées</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <span>6-12 mois</span>
                                <strong>{{ metrics.duration_analysis.short_duration ?? 0 }}</strong>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <span>12-18 mois</span>
                                <strong>{{ metrics.duration_analysis.medium_duration ?? 0 }}</strong>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <span>18-24 mois</span>
                                <strong>{{ metrics.duration_analysis.long_duration ?? 0 }}</strong>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <span>24+ mois</span>
                                <strong>{{ metrics.duration_analysis.extended_duration ?? 0 }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mentor Performance -->
    {% if metrics.mentor_performance|length > 0 %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom">
                        <h5 class="card-title mb-0">Performance des Mentors</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Mentor</th>
                                        <th>Contrats Actifs</th>
                                        <th>Contrats Terminés</th>
                                        <th>Taux de Réussite</th>
                                        <th>Note Moyenne</th>
                                        <th>Dernière Activité</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for mentor in metrics.mentor_performance %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar avatar-sm me-2">
                                                        <span class="avatar-initials">{{ mentor.initials }}</span>
                                                    </div>
                                                    <div>
                                                        <strong>{{ mentor.name }}</strong>
                                                        <br>
                                                        <small class="text-muted">{{ mentor.company }}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>{{ mentor.active_contracts }}</td>
                                            <td>{{ mentor.completed_contracts }}</td>
                                            <td>
                                                <span class="badge bg-{{ mentor.success_rate >= 80 ? 'success' : (mentor.success_rate >= 60 ? 'warning' : 'danger') }}">
                                                    {{ mentor.success_rate }}%
                                                </span>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="me-1">{{ mentor.average_rating }}/5</span>
                                                    <div class="text-warning">
                                                        {% for i in 1..5 %}
                                                            <i class="fas fa-star{{ i <= mentor.average_rating ? '' : '-o' }}"></i>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </td>
                                            <td>{{ mentor.last_activity|date('d/m/Y') }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Risk Analysis -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">Analyse des Risques</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="text-center p-3 border rounded border-danger">
                                <h4 class="text-danger mb-1">{{ metrics.risk_analysis.high_risk_contracts }}</h4>
                                <p class="text-muted mb-0">Risque Élevé</p>
                                <small class="text-muted">Nécessitent une attention immédiate</small>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="text-center p-3 border rounded border-warning">
                                <h4 class="text-warning mb-1">{{ metrics.risk_analysis.medium_risk_contracts }}</h4>
                                <p class="text-muted mb-0">Risque Modéré</p>
                                <small class="text-muted">À surveiller de près</small>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="text-center p-3 border rounded border-success">
                                <h4 class="text-success mb-1">{{ metrics.risk_analysis.low_risk_contracts }}</h4>
                                <p class="text-muted mb-0">Faible Risque</p>
                                <small class="text-muted">En bon état</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Duration Analysis Chart
        const durationCtx = document.getElementById('durationAnalysisChart').getContext('2d');
        const durationChart = new Chart(durationCtx, {
            type: 'bar',
            data: {
                labels: ['6-12 mois', '12-18 mois', '18-24 mois', '24+ mois'],
                datasets: [{
                    label: 'Nombre de Contrats',
                    data: [
                        {{ metrics.duration_analysis.short_duration ?? 0 }},
                        {{ metrics.duration_analysis.medium_duration ?? 0 }},
                        {{ metrics.duration_analysis.long_duration ?? 0 }},
                        {{ metrics.duration_analysis.extended_duration ?? 0 }}
                    ],
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 205, 86, 0.8)',
                        'rgba(255, 99, 132, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        function exportToExcel() {
            // Implementation for Excel export
            alert('Export Excel en cours de développement');
        }

        function exportToPDF() {
            // Implementation for PDF export
            alert('Export PDF en cours de développement');
        }

        function exportToCSV() {
            // Implementation for CSV export
            alert('Export CSV en cours de développement');
        }
    </script>
{% endblock %}
