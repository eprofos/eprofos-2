{% extends 'admin/base.html.twig' %}

{% block title %}Gestion des Évaluations{% endblock %}

{% block page_title %}Gestion des Évaluations{% endblock %}

{% block body %}
<div class="row mb-4">
    <div class="col-md-12">
        <!-- Statistics Cards -->
        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="subheader">Total évaluations</div>
                        </div>
                        <div class="h1 mb-0">{{ statistics.total_evaluations }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="subheader">En attente</div>
                        </div>
                        <div class="h1 mb-0 text-warning">{{ statistics.pending_validation }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="subheader">Validées ce mois</div>
                        </div>
                        <div class="h1 mb-0 text-success">{{ statistics.validated_this_month }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="subheader">Score moyen</div>
                        </div>
                        <div class="h1 mb-0">{{ (statistics.average_score * 100)|round(1) }}%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title">Toutes les Évaluations</h3>
                <div class="card-actions">
                    <a href="{{ path('admin_alternance_evaluation_progress') }}" class="btn btn-outline-primary">
                        <i class="fas fa-chart-line"></i>
                        Progressions
                    </a>
                    <a href="{{ path('admin_alternance_evaluation_skills') }}" class="btn btn-outline-primary">
                        <i class="fas fa-certificate"></i>
                        Compétences
                    </a>
                    <a href="{{ path('admin_alternance_evaluation_analytics') }}" class="btn btn-outline-info">
                        <i class="fas fa-chart-bar"></i>
                        Analytics
                    </a>
                    <a href="{{ path('admin_alternance_evaluation_export') }}" class="btn btn-outline-success">
                        <i class="fas fa-download"></i>
                        Export
                    </a>
                </div>
            </div>

            <div class="card-body">
                <!-- Filters -->
                <form method="GET" class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <input type="text" name="search" class="form-control" placeholder="Rechercher..."
                                   value="{{ filters.search }}">
                        </div>
                        <div class="col-md-2">
                            <select name="type" class="form-select">
                                <option value="">Tous types</option>
                                <option value="progress"{% if filters.type == 'progress' %} selected{% endif %}>Progression</option>
                                <option value="skills"{% if filters.type == 'skills' %} selected{% endif %}>Compétences</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select name="status" class="form-select">
                                <option value="">Tous statuts</option>
                                <option value="pending"{% if filters.status == 'pending' %} selected{% endif %}>En attente</option>
                                <option value="validated"{% if filters.status == 'validated' %} selected{% endif %}>Validé</option>
                                <option value="rejected"{% if filters.status == 'rejected' %} selected{% endif %}>Rejeté</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i>
                                Filtrer
                            </button>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ path('admin_alternance_evaluation_index') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i>
                                Réinitialiser
                            </a>
                        </div>
                    </div>
                </form>

                <!-- Evaluations Table -->
                {% if evaluations is not empty %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="select-all" class="form-check-input">
                                </th>
                                <th>Type</th>
                                <th>Alternant</th>
                                <th>Mentor</th>
                                <th>Date</th>
                                <th>Statut</th>
                                <th>Score</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for evaluation in evaluations %}
                            <tr>
                                <td>
                                    <input type="checkbox" name="evaluation_ids[]" 
                                           value="{{ evaluation.id }}" 
                                           data-type="{{ evaluation.entityType }}"
                                           class="form-check-input evaluation-checkbox">
                                </td>
                                <td>
                                    {% if evaluation.entityType == 'progress' %}
                                        <span class="badge bg-blue text-white">Progression</span>
                                    {% else %}
                                        <span class="badge bg-green text-white">Compétences</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div>
                                            <strong>{{ evaluation.student.fullName }}</strong>
                                            <div class="text-muted small">{{ evaluation.student.email }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if evaluation.mentor %}
                                        {{ evaluation.mentor.fullName }}
                                    {% else %}
                                        <span class="text-muted">Non assigné</span>
                                    {% endif %}
                                </td>
                                <td>{{ evaluation.createdAt|date('d/m/Y H:i') }}</td>
                                <td>
                                    {% if evaluation.status == 'pending' %}
                                        <span class="badge bg-warning text-white">En attente</span>
                                    {% elseif evaluation.status == 'validated' %}
                                        <span class="badge bg-success text-white">Validé</span>
                                    {% elseif evaluation.status == 'rejected' %}
                                        <span class="badge bg-danger text-white">Rejeté</span>
                                    {% else %}
                                        <span class="badge bg-secondary text-white">{{ evaluation.status }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if evaluation.overallScore is not null %}
                                        <div class="progress" style="width: 60px;">
                                            <div class="progress-bar" style="width: {{ (evaluation.overallScore * 100)|round }}%">
                                                {{ (evaluation.overallScore * 100)|round }}%
                                            </div>
                                        </div>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group">
                                        {% if evaluation.entityType == 'progress' %}
                                            <a href="{{ path('admin_alternance_evaluation_progress_show', {id: evaluation.id}) }}" 
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        {% else %}
                                            <a href="{{ path('admin_alternance_evaluation_skills_show', {id: evaluation.id}) }}" 
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Bulk Actions -->
                <div class="d-flex justify-content-between align-items-center mt-3" id="bulk-actions" style="display: none !important;">
                    <div>
                        <strong id="selected-count">0</strong> évaluation(s) sélectionnée(s)
                    </div>
                    <div>
                        <form method="POST" action="{{ path('admin_alternance_evaluation_bulk_actions') }}" style="display: inline;">
                            <input type="hidden" name="type" id="bulk-type" value="">
                            <input type="hidden" name="evaluation_ids" id="bulk-ids" value="">
                            <button type="submit" name="action" value="approve" class="btn btn-sm btn-success">
                                <i class="fas fa-check"></i> Approuver
                            </button>
                            <button type="submit" name="action" value="archive" class="btn btn-sm btn-secondary">
                                <i class="fas fa-archive"></i> Archiver
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Pagination -->
                {% if total_pages > 1 %}
                <nav aria-label="Pagination des évaluations" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if current_page > 1 %}
                            <li class="page-item">
                                <a class="page-link" href="{{ path('admin_alternance_evaluation_index', filters|merge({page: current_page - 1})) }}">
                                    Précédent
                                </a>
                            </li>
                        {% endif %}

                        {% for page in 1..total_pages %}
                            {% if page == current_page %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page }}</span>
                                </li>
                            {% elseif page <= 3 or page > total_pages - 3 or (page >= current_page - 1 and page <= current_page + 1) %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ path('admin_alternance_evaluation_index', filters|merge({page: page})) }}">
                                        {{ page }}
                                    </a>
                                </li>
                            {% elseif page == 4 or page == total_pages - 3 %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if current_page < total_pages %}
                            <li class="page-item">
                                <a class="page-link" href="{{ path('admin_alternance_evaluation_index', filters|merge({page: current_page + 1})) }}">
                                    Suivant
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}

                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-chart-line" style="font-size: 4rem; opacity: 0.3;"></i>
                    <h4 class="mt-3">Aucune évaluation trouvée</h4>
                    <p class="text-muted">Aucune évaluation ne correspond aux critères de recherche.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Activité Récente</h3>
            </div>
            <div class="card-body">
                {% if statistics.recent_activity is not empty %}
                <div class="list-group list-group-flush">
                    {% for activity in statistics.recent_activity %}
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                {% if activity.type == 'progress' %}
                                    <span class="avatar bg-blue text-white">P</span>
                                {% else %}
                                    <span class="avatar bg-green text-white">C</span>
                                {% endif %}
                            </div>
                            <div class="col text-truncate">
                                <strong>{{ activity.evaluation.student.fullName }}</strong>
                                - {{ activity.type == 'progress' ? 'Évaluation de progression' : 'Évaluation de compétences' }}
                                <div class="text-muted">
                                    {% if activity.evaluation.mentor %}
                                        Mentor: {{ activity.evaluation.mentor.fullName }}
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-auto text-muted">
                                {{ activity.date|date('d/m/Y H:i') }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center">Aucune activité récente</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.evaluation-checkbox');
    const bulkActions = document.getElementById('bulk-actions');
    const selectedCount = document.getElementById('selected-count');
    const bulkType = document.getElementById('bulk-type');
    const bulkIds = document.getElementById('bulk-ids');

    function updateBulkActions() {
        const selected = document.querySelectorAll('.evaluation-checkbox:checked');
        const count = selected.length;
        
        selectedCount.textContent = count;
        
        if (count > 0) {
            bulkActions.style.display = 'flex';
            
            // Determine type based on first selected item
            const firstSelected = selected[0];
            const type = firstSelected.dataset.type;
            bulkType.value = type;
            
            // Collect IDs
            const ids = Array.from(selected).map(cb => cb.value);
            bulkIds.value = ids.join(',');
        } else {
            bulkActions.style.display = 'none';
        }
    }

    selectAll.addEventListener('change', function() {
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateBulkActions();
    });

    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActions);
    });
});
</script>
{% endblock %}
