{% extends 'admin/base.html.twig' %}

{% block title %}Aperçu : {{ ui_template.name }} - {{ parent() }}{% endblock %}

{% block page_title %}Aperçu : {{ ui_template.name }}{% endblock %}

{% block breadcrumb %}
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ path('admin_document_index') }}">Documents</a></li>
            <li class="breadcrumb-item"><a href="{{ path('admin_document_ui_template_index') }}">Modèles UI</a></li>
            <li class="breadcrumb-item"><a href="{{ path('admin_document_ui_template_show', {id: ui_template.id}) }}">{{ ui_template.name }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">Aperçu</li>
        </ol>
    </nav>
{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-eye me-2"></i>
                        Aperçu du document
                    </h4>
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="zoom-out">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="zoom-reset">
                            100%
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="zoom-in">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <a href="{{ path('admin_document_ui_template_edit', {id: ui_template.id}) }}" 
                           class="btn btn-primary btn-sm">
                            <i class="fas fa-edit me-1"></i>
                            Modifier
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="preview-container" style="background: #f8f9fa; padding: 20px; overflow: auto;">
                        <div class="document-preview" id="document-preview" style="
                            background: white;
                            margin: 0 auto;
                            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                            transform-origin: top center;
                            {% if ui_template.paperSize == 'A4' %}
                                width: 210mm;
                                min-height: 297mm;
                            {% elseif ui_template.paperSize == 'A3' %}
                                width: 297mm;
                                min-height: 420mm;
                            {% elseif ui_template.paperSize == 'Letter' %}
                                width: 8.5in;
                                min-height: 11in;
                            {% else %}
                                width: 210mm;
                                min-height: 297mm;
                            {% endif %}
                            {% if ui_template.orientation == 'landscape' %}
                                transform: rotate(90deg) translateY(-100%);
                                transform-origin: top left;
                            {% endif %}
                            padding: {{ ui_template.marginTop }}mm {{ ui_template.marginRight }}mm {{ ui_template.marginBottom }}mm {{ ui_template.marginLeft }}mm;
                        ">
                            <!-- Custom CSS -->
                            {% if ui_template.customCss %}
                                <style>
                                    {{ ui_template.customCss|raw }}
                                </style>
                            {% endif %}
                            
                            <!-- Render the actual template HTML -->
                            {% if rendered_html %}
                                {{ rendered_html|raw }}
                            {% else %}
                                <div class="alert alert-warning m-3">
                                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Aucun contenu à afficher</h5>
                                    <p class="mb-2">Le modèle ne contient pas de contenu rendu. Cela peut être dû à :</p>
                                    <ul class="mb-2">
                                        <li>Aucun composant n'est configuré dans ce modèle</li>
                                        <li>Tous les composants sont inactifs</li>
                                        <li>Erreur dans le service de rendu</li>
                                    </ul>
                                    <p class="mb-0">
                                        <strong>Nombre de composants :</strong> {{ ui_template.components|length }}<br>
                                        <strong>Composants actifs :</strong> {{ ui_template.components|filter(c => c.isActive)|length }}
                                    </p>
                                    {% if ui_template.components|length == 0 %}
                                        <hr>
                                        <a href="{{ path('admin_document_ui_component_new', {templateId: ui_template.id}) }}" 
                                           class="btn btn-primary">
                                            <i class="fas fa-plus me-1"></i>
                                            Ajouter un composant
                                        </a>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Template Info -->
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Informations
                    </h4>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Format :</strong></td>
                            <td>{{ ui_template.paperSize }} {{ ui_template.orientation == 'landscape' ? 'Paysage' : 'Portrait' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Marges :</strong></td>
                            <td>{{ ui_template.marginTop }}mm / {{ ui_template.marginRight }}mm / {{ ui_template.marginBottom }}mm / {{ ui_template.marginLeft }}mm</td>
                        </tr>
                        <tr>
                            <td><strong>Composants :</strong></td>
                            <td>{{ ui_template.components|length }}</td>
                        </tr>
                        {% if ui_template.color %}
                        <tr>
                            <td><strong>Couleur :</strong></td>
                            <td>
                                <span class="badge" style="background-color: {{ ui_template.color }}; color: white;">
                                    {{ ui_template.color }}
                                </span>
                            </td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
            
            <!-- Debug Components -->
            {% if ui_template.components|length > 0 %}
            <div class="card mt-3">
                <div class="card-header">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-bug me-2"></i>
                        Debug - Composants
                    </h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Type</th>
                                    <th>Zone</th>
                                    <th>Actif</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for component in ui_template.components %}
                                <tr>
                                    <td>{{ component.name }}</td>
                                    <td><span class="badge bg-secondary">{{ component.type }}</span></td>
                                    <td><span class="badge bg-info">{{ component.zone }}</span></td>
                                    <td>
                                        {% if component.isActive %}
                                            <span class="badge bg-success">Oui</span>
                                        {% else %}
                                            <span class="badge bg-danger">Non</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Sample Data -->
            <div class="card mt-3">
                <div class="card-header">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-database me-2"></i>
                        Données d'exemple
                    </h4>
                </div>
                <div class="card-body">
                    <form id="sample-data-form">
                        <div class="mb-3">
                            <label for="sample-title" class="form-label">Titre du document</label>
                            <input type="text" class="form-control form-control-sm" id="sample-title" 
                                   value="Document d'exemple" onchange="updatePreview()">
                        </div>
                        <div class="mb-3">
                            <label for="sample-content" class="form-label">Contenu</label>
                            <textarea class="form-control form-control-sm" id="sample-content" rows="3" 
                                      onchange="updatePreview()">Ceci est le contenu d'exemple du document pour tester l'affichage du modèle UI.</textarea>
                        </div>
                        <div class="mb-3">
                            <label for="sample-user" class="form-label">Utilisateur</label>
                            <input type="text" class="form-control form-control-sm" id="sample-user" 
                                   value="Jean Dupont" onchange="updatePreview()">
                        </div>
                        <button type="button" class="btn btn-primary btn-sm w-100" onclick="updatePreview()">
                            <i class="fas fa-refresh me-1"></i>
                            Actualiser l'aperçu
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="card mt-3">
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ path('admin_document_ui_template_edit', {id: ui_template.id}) }}" 
                           class="btn btn-primary">
                            <i class="fas fa-edit me-1"></i>
                            Modifier le modèle
                        </a>
                        <a href="{{ path('admin_document_ui_component_index', {templateId: ui_template.id}) }}" 
                           class="btn btn-secondary">
                            <i class="fas fa-puzzle-piece me-1"></i>
                            Gérer les composants
                        </a>
                        <a href="{{ path('admin_document_ui_template_show', {id: ui_template.id}) }}" 
                           class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>
                            Retour aux détails
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        let currentZoom = 1;
        
        document.addEventListener('DOMContentLoaded', function() {
            const preview = document.getElementById('document-preview');
            const zoomInBtn = document.getElementById('zoom-in');
            const zoomOutBtn = document.getElementById('zoom-out');
            const zoomResetBtn = document.getElementById('zoom-reset');
            
            function updateZoom() {
                preview.style.transform = `scale(${currentZoom})`;
                zoomResetBtn.textContent = Math.round(currentZoom * 100) + '%';
            }
            
            zoomInBtn.addEventListener('click', function() {
                if (currentZoom < 2) {
                    currentZoom += 0.1;
                    updateZoom();
                }
            });
            
            zoomOutBtn.addEventListener('click', function() {
                if (currentZoom > 0.3) {
                    currentZoom -= 0.1;
                    updateZoom();
                }
            });
            
            zoomResetBtn.addEventListener('click', function() {
                currentZoom = 1;
                updateZoom();
            });
        });
        
        function updatePreview() {
            const title = document.getElementById('sample-title').value;
            const content = document.getElementById('sample-content').value;
            const user = document.getElementById('sample-user').value;
            
            // This would normally make an AJAX call to update the preview
            // For now, we'll just update some basic text elements if they exist
            const titleElements = document.querySelectorAll('[data-variable="document.title"]');
            const contentElements = document.querySelectorAll('[data-variable="document.content"]');
            const userElements = document.querySelectorAll('[data-variable="user.name"]');
            
            titleElements.forEach(el => el.textContent = title);
            contentElements.forEach(el => el.textContent = content);
            userElements.forEach(el => el.textContent = user);
            
            // Update date elements
            const now = new Date();
            const dateElements = document.querySelectorAll('[data-variable="date.now"]');
            dateElements.forEach(el => el.textContent = now.toLocaleDateString('fr-FR'));
        }
        
        // Auto-update preview when typing
        document.getElementById('sample-data-form').addEventListener('input', function() {
            clearTimeout(this.updateTimeout);
            this.updateTimeout = setTimeout(updatePreview, 500);
        });
    </script>
{% endblock %}
