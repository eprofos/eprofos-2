{% extends 'admin/base.html.twig' %}

{% block title %}Modification de Statut en Lot{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Modification de Statut en Lot</h1>
        <a href="{{ path('admin_student_enrollment_index') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Retour à la liste
        </a>
    </div>

    <!-- Status Change Form -->
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Modifier le statut des inscriptions</h5>
                </div>
                <form method="POST">
                    <div class="card-body">
                        <!-- Current Status Filter -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="current_status" class="form-label">Statut actuel</label>
                                <select class="form-select" id="current_status" name="current_status">
                                    <option value="">Tous les statuts</option>
                                    <option value="registered">Inscrit</option>
                                    <option value="confirmed">Confirmé</option>
                                    <option value="pending">En attente</option>
                                    <option value="cancelled">Annulé</option>
                                    <option value="completed">Terminé</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="session_filter" class="form-label">Session</label>
                                <select class="form-select" id="session_filter" name="session_filter">
                                    <option value="">Toutes les sessions</option>
                                    {% for session in sessions %}
                                        <option value="{{ session.id }}">
                                            {{ session.formation.title }} - {{ session.name }}
                                            ({{ session.startDate|date('d/m/Y') }})
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- New Status Selection -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="new_status" class="form-label">Nouveau statut <span class="text-danger">*</span></label>
                                <select class="form-select" id="new_status" name="new_status" required>
                                    <option value="">Sélectionner un nouveau statut</option>
                                    <option value="confirmed">Confirmé</option>
                                    <option value="pending">En attente</option>
                                    <option value="cancelled">Annulé</option>
                                    <option value="completed">Terminé</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="reason" class="form-label">Raison du changement</label>
                                <select class="form-select" id="reason" name="reason">
                                    <option value="">Sélectionner une raison</option>
                                    <option value="administrative">Décision administrative</option>
                                    <option value="student_request">Demande de l'étudiant</option>
                                    <option value="capacity">Problème de capacité</option>
                                    <option value="prerequisite">Prérequis non remplis</option>
                                    <option value="technical">Problème technique</option>
                                    <option value="completion">Fin de formation</option>
                                    <option value="other">Autre</option>
                                </select>
                            </div>
                        </div>

                        <!-- Custom Reason -->
                        <div class="row mb-4" id="custom_reason_container" style="display: none;">
                            <div class="col-md-12">
                                <label for="custom_reason" class="form-label">Raison personnalisée</label>
                                <textarea class="form-control" id="custom_reason" name="custom_reason" rows="3" 
                                          placeholder="Veuillez préciser la raison..."></textarea>
                            </div>
                        </div>

                        <!-- Options -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <h6>Options</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="notify_students" 
                                           name="notify_students" value="1">
                                    <label class="form-check-label" for="notify_students">
                                        Notifier les étudiants par email
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="force_change" 
                                           name="force_change" value="1">
                                    <label class="form-check-label" for="force_change">
                                        Forcer le changement même si le nouveau statut est identique
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Load and Preview -->
                        <div class="row">
                            <div class="col-md-12">
                                <button type="button" class="btn btn-outline-primary" id="load_enrollments">
                                    <i class="fas fa-search"></i> Charger les inscriptions correspondantes
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Preview Results -->
            <div class="card mt-4" id="preview_card" style="display: none;">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        Inscriptions trouvées 
                        <span class="badge bg-primary" id="enrollment_count">0</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div id="enrollments_preview">
                        <!-- Preview content will be loaded here -->
                    </div>
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary" id="apply_changes" disabled>
                            <i class="fas fa-check"></i> Appliquer les modifications
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Help Panel -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-info-circle"></i> Guide des Statuts
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <span class="badge bg-info">Inscrit</span>
                        <p class="small mt-1 mb-0">Inscription initiale, en attente de confirmation</p>
                    </div>
                    <div class="mb-3">
                        <span class="badge bg-success">Confirmé</span>
                        <p class="small mt-1 mb-0">Inscription confirmée, place réservée</p>
                    </div>
                    <div class="mb-3">
                        <span class="badge bg-warning">En attente</span>
                        <p class="small mt-1 mb-0">En liste d'attente ou en attente de validation</p>
                    </div>
                    <div class="mb-3">
                        <span class="badge bg-danger">Annulé</span>
                        <p class="small mt-1 mb-0">Inscription annulée par l'étudiant ou l'admin</p>
                    </div>
                    <div class="mb-3">
                        <span class="badge bg-dark">Terminé</span>
                        <p class="small mt-1 mb-0">Formation terminée</p>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-exclamation-triangle"></i> Attention
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <small>
                            <strong>Important:</strong> Cette action est irréversible. 
                            Assurez-vous de vérifier les inscriptions avant d'appliquer les modifications.
                        </small>
                    </div>
                    <div class="alert alert-info">
                        <small>
                            <strong>Notifications:</strong> Si l'option est activée, 
                            les étudiants recevront un email les informant du changement de statut.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmer les modifications</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    Vous êtes sur le point de modifier le statut de <strong id="confirm_count">0</strong> inscription(s).
                </div>
                <div id="confirm_details">
                    <!-- Confirmation details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="confirm_apply">
                    Confirmer les modifications
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const reasonSelect = document.getElementById('reason');
    const customReasonContainer = document.getElementById('custom_reason_container');
    const loadButton = document.getElementById('load_enrollments');
    const previewCard = document.getElementById('preview_card');
    const applyButton = document.getElementById('apply_changes');
    
    // Show/hide custom reason field
    reasonSelect.addEventListener('change', function() {
        if (this.value === 'other') {
            customReasonContainer.style.display = 'block';
        } else {
            customReasonContainer.style.display = 'none';
        }
    });

    // Load enrollments
    loadButton.addEventListener('click', function() {
        const currentStatus = document.getElementById('current_status').value;
        const sessionFilter = document.getElementById('session_filter').value;
        const newStatus = document.getElementById('new_status').value;

        if (!newStatus) {
            alert('Veuillez sélectionner un nouveau statut');
            return;
        }

        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Chargement...';

        fetch(`{{ path('admin_enrollment_bulk_load_for_status_change') }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                current_status: currentStatus,
                session_filter: sessionFilter,
                new_status: newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayEnrollmentPreview(data.enrollments);
                previewCard.style.display = 'block';
                applyButton.disabled = data.enrollments.length === 0;
            } else {
                alert('Erreur: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Load error:', error);
            alert('Erreur lors du chargement des inscriptions');
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-search"></i> Charger les inscriptions correspondantes';
        });
    });

    function displayEnrollmentPreview(enrollments) {
        const countBadge = document.getElementById('enrollment_count');
        const previewContainer = document.getElementById('enrollments_preview');
        
        countBadge.textContent = enrollments.length;

        if (enrollments.length === 0) {
            previewContainer.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Aucune inscription trouvée avec les critères sélectionnés.
                </div>
            `;
            return;
        }

        const html = `
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="select_all" checked>
                            </th>
                            <th>Étudiant</th>
                            <th>Session</th>
                            <th>Statut actuel</th>
                            <th>Date d'inscription</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${enrollments.map(enrollment => `
                            <tr>
                                <td>
                                    <input type="checkbox" class="enrollment-checkbox" 
                                           value="${enrollment.id}" checked>
                                </td>
                                <td>
                                    <strong>${enrollment.student_name}</strong>
                                    <br>
                                    <small class="text-muted">${enrollment.student_email}</small>
                                </td>
                                <td>
                                    ${enrollment.session_name}
                                    <br>
                                    <small class="text-muted">${enrollment.formation_title}</small>
                                </td>
                                <td>
                                    <span class="badge ${getStatusBadgeClass(enrollment.status)}">
                                        ${getStatusLabel(enrollment.status)}
                                    </span>
                                </td>
                                <td>
                                    <small>${new Date(enrollment.registration_date).toLocaleDateString('fr-FR')}</small>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;

        previewContainer.innerHTML = html;

        // Handle select all checkbox
        const selectAll = document.getElementById('select_all');
        const checkboxes = document.querySelectorAll('.enrollment-checkbox');
        
        selectAll.addEventListener('change', function() {
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });

        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                const noneChecked = Array.from(checkboxes).every(cb => !cb.checked);
                
                selectAll.checked = allChecked;
                selectAll.indeterminate = !allChecked && !noneChecked;
                
                // Update apply button
                const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
                applyButton.disabled = selectedCount === 0;
            });
        });
    }

    function getStatusBadgeClass(status) {
        const classes = {
            'registered': 'bg-info',
            'confirmed': 'bg-success',
            'pending': 'bg-warning',
            'cancelled': 'bg-danger',
            'completed': 'bg-dark'
        };
        return classes[status] || 'bg-secondary';
    }

    function getStatusLabel(status) {
        const labels = {
            'registered': 'Inscrit',
            'confirmed': 'Confirmé',
            'pending': 'En attente',
            'cancelled': 'Annulé',
            'completed': 'Terminé'
        };
        return labels[status] || status;
    }

    // Apply changes
    applyButton.addEventListener('click', function() {
        const selectedIds = Array.from(document.querySelectorAll('.enrollment-checkbox:checked'))
            .map(checkbox => checkbox.value);
        
        if (selectedIds.length === 0) {
            alert('Veuillez sélectionner au moins une inscription');
            return;
        }

        const newStatus = document.getElementById('new_status').value;
        const reason = document.getElementById('reason').value;
        const customReason = document.getElementById('custom_reason').value;
        const finalReason = reason === 'other' ? customReason : reason;

        // Show confirmation modal
        document.getElementById('confirm_count').textContent = selectedIds.length;
        document.getElementById('confirm_details').innerHTML = `
            <p><strong>Nouveau statut:</strong> <span class="badge ${getStatusBadgeClass(newStatus)}">${getStatusLabel(newStatus)}</span></p>
            ${finalReason ? `<p><strong>Raison:</strong> ${finalReason}</p>` : ''}
            <p><strong>Notification:</strong> ${document.getElementById('notify_students').checked ? 'Oui' : 'Non'}</p>
        `;

        const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        modal.show();

        // Handle confirmation
        document.getElementById('confirm_apply').onclick = function() {
            modal.hide();
            performStatusChange(selectedIds);
        };
    });

    function performStatusChange(enrollmentIds) {
        const formData = new FormData();
        formData.append('enrollment_ids', JSON.stringify(enrollmentIds));
        formData.append('new_status', document.getElementById('new_status').value);
        formData.append('reason', document.getElementById('reason').value);
        formData.append('custom_reason', document.getElementById('custom_reason').value);
        formData.append('notify_students', document.getElementById('notify_students').checked ? '1' : '0');
        formData.append('force_change', document.getElementById('force_change').checked ? '1' : '0');

        applyButton.disabled = true;
        applyButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Application en cours...';

        fetch(`{{ path('admin_enrollment_bulk_status_change') }}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Modifications appliquées avec succès sur ${data.updated_count} inscription(s)`);
                window.location.href = `{{ path('admin_student_enrollment_index') }}`;
            } else {
                alert('Erreur: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Apply error:', error);
            alert('Erreur lors de l\'application des modifications');
        })
        .finally(() => {
            applyButton.disabled = false;
            applyButton.innerHTML = '<i class="fas fa-check"></i> Appliquer les modifications';
        });
    }
});
</script>
{% endblock %}
