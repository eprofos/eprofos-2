{% extends 'admin/base.html.twig' %}

{% block title %}Suivi Détaillé des Progressions{% endblock %}

{% block body %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="fas fa-chart-line text-primary me-2"></i>
                Suivi Détaillé des Progressions
            </h1>
            <p class="text-muted">
                Vue détaillée de la progression de tous les étudiants inscrits
            </p>
        </div>
        <div class="btn-group">
            <a href="{{ path('admin_progress_monitoring_index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Tableau de bord
            </a>
            <a href="{{ path('admin_progress_monitoring_at_risk') }}" class="btn btn-outline-warning">
                <i class="fas fa-exclamation-triangle me-1"></i> Étudiants à risque
            </a>
            <button type="button" class="btn btn-success" onclick="window.print()">
                <i class="fas fa-print me-1"></i> Imprimer
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">Total Étudiants</h6>
                            <h3 class="mb-0">{{ enrollments.getTotalItemCount }}</h3>
                        </div>
                        <div class="text-white-50">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">Progression Élevée</h6>
                            <h3 class="mb-0">
                                {{ enrollments|filter(e => e.progress and e.progress.completionPercentage > 75)|length }}
                            </h3>
                        </div>
                        <div class="text-white-50">
                            <i class="fas fa-chart-line fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">Progression Modérée</h6>
                            <h3 class="mb-0">
                                {{ enrollments|filter(e => e.progress and e.progress.completionPercentage >= 25 and e.progress.completionPercentage <= 75)|length }}
                            </h3>
                        </div>
                        <div class="text-white-50">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">Progression Faible</h6>
                            <h3 class="mb-0">
                                {{ enrollments|filter(e => e.progress and e.progress.completionPercentage < 25)|length }}
                            </h3>
                        </div>
                        <div class="text-white-50">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-filter me-2"></i>
                Filtres et Recherche
            </h5>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label for="formation" class="form-label">Formation</label>
                    <select class="form-select" id="formation" name="formation">
                        <option value="">Toutes les formations</option>
                        {% for formation in formations %}
                            <option value="{{ formation.id }}" {{ filters.formation == formation.id ? 'selected' : '' }}>
                                {{ formation.title }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="status" class="form-label">Statut</label>
                    <select class="form-select" id="status" name="status">
                        <option value="enrolled" {{ filters.status == 'enrolled' ? 'selected' : '' }}>Inscrit</option>
                        <option value="completed" {{ filters.status == 'completed' ? 'selected' : '' }}>Terminé</option>
                        <option value="dropped_out" {{ filters.status == 'dropped_out' ? 'selected' : '' }}>Abandonné</option>
                        <option value="suspended" {{ filters.status == 'suspended' ? 'selected' : '' }}>Suspendu</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="progress_filter" class="form-label">Progression</label>
                    <select class="form-select" id="progress_filter" name="progress_filter">
                        <option value="">Toutes</option>
                        <option value="low" {{ filters.progress_filter == 'low' ? 'selected' : '' }}>Faible (&lt;25%)</option>
                        <option value="medium" {{ filters.progress_filter == 'medium' ? 'selected' : '' }}>Modérée (25-75%)</option>
                        <option value="high" {{ filters.progress_filter == 'high' ? 'selected' : '' }}>Élevée (&gt;75%)</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="risk_filter" class="form-label">Facteur de Risque</label>
                    <select class="form-select" id="risk_filter" name="risk_filter">
                        <option value="">Tous</option>
                        <option value="at_risk" {{ filters.risk_filter == 'at_risk' ? 'selected' : '' }}>À risque</option>
                        <option value="low_engagement" {{ filters.risk_filter == 'low_engagement' ? 'selected' : '' }}>Faible engagement</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="search" class="form-label">Recherche (nom, email)</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="search" name="search" 
                               value="{{ filters.search }}" placeholder="Rechercher un étudiant...">
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </form>
            
            {% if filters.formation or filters.progress_filter or filters.risk_filter or filters.search %}
                <div class="mt-3">
                    <a href="{{ path('admin_progress_monitoring_detailed') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-times me-1"></i> Effacer les filtres
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Detailed Progress Table -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-table me-2"></i>
                    Progression Détaillée des Étudiants
                </h5>
                <small class="text-muted">
                    {{ enrollments.getCurrentPageOffsetStart }} - {{ enrollments.getCurrentPageOffsetEnd }} 
                    sur {{ enrollments.getTotalItemCount }} résultats
                </small>
            </div>
        </div>
        <div class="card-body p-0">
            {% if enrollments|length > 0 %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">
                                    <input type="checkbox" class="form-check-input" id="selectAll">
                                </th>
                                <th scope="col">Étudiant</th>
                                <th scope="col">Formation</th>
                                <th scope="col">Statut</th>
                                <th scope="col">Progression</th>
                                <th scope="col">Engagement</th>
                                <th scope="col">Dernière Activité</th>
                                <th scope="col">Temps Passé</th>
                                <th scope="col">Risque</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for enrollment in enrollments %}
                                {% set progress = enrollment.progress %}
                                {% set completionPercent = progress ? progress.completionPercentage ?? 0 : 0 %}
                                {% set engagementLevel = progress ? progress.engagementLevel ?? 0 : 0 %}
                                {% set isAtRisk = progress ? progress.atRiskOfDropout : false %}
                                {% set riskScore = progress ? progress.riskScore ?? 0 : 0 %}
                                
                                <tr>
                                    <td>
                                        <input type="checkbox" class="form-check-input enrollment-checkbox" 
                                               value="{{ enrollment.id }}">
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar avatar-sm me-3">
                                                <div class="avatar-initial bg-primary text-white">
                                                    {{ enrollment.student.firstName|first }}{{ enrollment.student.lastName|first }}
                                                </div>
                                            </div>
                                            <div>
                                                <div class="fw-medium">{{ enrollment.student.fullName }}</div>
                                                <small class="text-muted">{{ enrollment.student.email }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <div class="fw-medium">{{ enrollment.formation.title }}</div>
                                            <small class="text-muted">{{ enrollment.formation.category.name }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge {{ enrollment.statusBadgeClass }}">
                                            {{ enrollment.statusLabel }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress flex-grow-1 me-2" style="height: 8px; min-width: 80px;">
                                                <div class="progress-bar 
                                                    {% if completionPercent < 25 %}bg-danger
                                                    {% elseif completionPercent < 75 %}bg-warning
                                                    {% else %}bg-success
                                                    {% endif %}" 
                                                     style="width: {{ completionPercent }}%"></div>
                                            </div>
                                            <small class="text-muted text-nowrap">{{ completionPercent }}%</small>
                                        </div>
                                        {% if progress and progress.moduleProgress %}
                                            <small class="text-muted">
                                                Modules: {{ progress.moduleProgress|length }} complétés
                                            </small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% for i in 1..5 %}
                                                <i class="fas fa-star {{ i <= engagementLevel ? 'text-warning' : 'text-muted' }} me-1"></i>
                                            {% endfor %}
                                        </div>
                                        <small class="text-muted">{{ engagementLevel }}/5</small>
                                    </td>
                                    <td>
                                        {% if progress and progress.lastActivity %}
                                            {% set daysSince = date().diff(progress.lastActivity).days %}
                                            <div class="text-{{ daysSince > 7 ? 'danger' : (daysSince > 3 ? 'warning' : 'success') }}">
                                                {{ progress.lastActivity|date('d/m/Y') }}
                                            </div>
                                            <small class="text-muted text-nowrap">
                                                Il y a {{ daysSince }} jour{{ daysSince > 1 ? 's' : '' }}
                                            </small>
                                        {% else %}
                                            <span class="text-muted">
                                                <i class="fas fa-minus"></i> Aucune
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if progress and progress.totalTimeSpent %}
                                            {% set hours = (progress.totalTimeSpent / 60)|round(1) %}
                                            <div class="fw-medium">{{ hours }}h</div>
                                            <small class="text-muted">{{ progress.totalTimeSpent }} min</small>
                                        {% else %}
                                            <span class="text-muted">
                                                <i class="fas fa-minus"></i> Non renseigné
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if isAtRisk %}
                                            <div class="d-flex align-items-center">
                                                <span class="badge 
                                                    {% if riskScore >= 70 %}bg-danger
                                                    {% elseif riskScore >= 40 %}bg-warning
                                                    {% else %}bg-info
                                                    {% endif %} me-2">
                                                    {{ riskScore }}%
                                                </span>
                                                <i class="fas fa-exclamation-triangle text-warning" 
                                                   title="Étudiant à risque de décrochage"></i>
                                            </div>
                                        {% else %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check"></i> OK
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ path('admin_progress_monitoring_show', {id: enrollment.id}) }}" 
                                               class="btn btn-outline-primary" title="Voir les détails">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ path('admin_student_enrollment_show', {id: enrollment.id}) }}" 
                                               class="btn btn-outline-info" title="Fiche d'inscription">
                                                <i class="fas fa-file-alt"></i>
                                            </a>
                                            {% if isAtRisk %}
                                                <button type="button" class="btn btn-outline-warning" 
                                                        data-bs-toggle="tooltip" 
                                                        title="Planifier intervention">
                                                    <i class="fas fa-user-md"></i>
                                                </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="card-footer">
                    {{ knp_pagination_render(enrollments) }}
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Aucun résultat trouvé</h5>
                    <p class="text-muted">
                        {% if filters.formation or filters.progress_filter or filters.risk_filter or filters.search %}
                            Aucun étudiant ne correspond à vos critères de filtrage.
                            <br>Essayez de modifier ou supprimer les filtres.
                        {% else %}
                            Aucune inscription active trouvée.
                        {% endif %}
                    </p>
                    <div class="mt-3">
                        <a href="{{ path('admin_progress_monitoring_detailed') }}" class="btn btn-primary">
                            <i class="fas fa-refresh me-1"></i> Actualiser
                        </a>
                        {% if filters.formation or filters.progress_filter or filters.risk_filter or filters.search %}
                            <a href="{{ path('admin_progress_monitoring_detailed') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-1"></i> Effacer les filtres
                            </a>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Bulk Actions -->
    {% if enrollments|length > 0 %}
    <div class="card mt-4" id="bulkActions" style="display: none;">
        <div class="card-header">
            <h6 class="card-title mb-0">
                <i class="fas fa-layer-group me-2"></i>
                Actions en Lot
                <span class="badge bg-primary ms-2" id="selectedCount">0</span>
            </h6>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ path('admin_progress_monitoring_bulk_intervention') }}" 
                  onsubmit="return confirm('Êtes-vous sûr de vouloir appliquer cette intervention à tous les étudiants sélectionnés ?')">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="intervention_type" class="form-label">Type d'intervention</label>
                        <select class="form-select" id="intervention_type" name="intervention_type" required>
                            <option value="">Sélectionner le type</option>
                            <option value="email">Envoi d'email de motivation</option>
                            <option value="call">Appel téléphonique</option>
                            <option value="meeting">Planifier un entretien</option>
                            <option value="support">Support pédagogique supplémentaire</option>
                            <option value="reminder">Rappel des échéances</option>
                            <option value="extension">Extension de délai</option>
                            <option value="resource">Ressources supplémentaires</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="notes" class="form-label">Notes sur l'intervention</label>
                        <input type="text" class="form-control" id="notes" name="notes" 
                               placeholder="Détails de l'intervention..." required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-warning d-grid">
                            <i class="fas fa-play me-1"></i> Appliquer
                        </button>
                    </div>
                </div>
                
                <!-- Hidden inputs for selected enrollments (populated by JavaScript) -->
                <div id="selectedEnrollmentIds"></div>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.enrollment-checkbox');
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    const selectedEnrollmentIds = document.getElementById('selectedEnrollmentIds');

    function updateBulkActions() {
        const checkedBoxes = document.querySelectorAll('.enrollment-checkbox:checked');
        const count = checkedBoxes.length;
        
        selectedCount.textContent = count;
        bulkActions.style.display = count > 0 ? 'block' : 'none';
        
        // Update hidden inputs
        selectedEnrollmentIds.innerHTML = '';
        checkedBoxes.forEach(checkbox => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'enrollment_ids[]';
            input.value = checkbox.value;
            selectedEnrollmentIds.appendChild(input);
        });
    }

    // Select all functionality
    selectAll.addEventListener('change', function() {
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateBulkActions();
    });

    // Individual checkbox functionality
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateBulkActions();
            
            // Update select all checkbox
            const checkedCount = document.querySelectorAll('.enrollment-checkbox:checked').length;
            selectAll.checked = checkedCount === checkboxes.length;
            selectAll.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
        });
    });

    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
