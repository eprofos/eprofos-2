{% extends 'base.html.twig' %}

{% block title %}Analyse des besoins - {{ request.companyName ?? request.recipientName }}{% endblock %}

{% block body %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="text-center mb-5">
                <div class="mb-4">
                    <img src="{{ asset('images/eprofos-logo.png') }}" alt="EPROFOS" class="img-fluid" style="max-height: 80px;">
                </div>
                <h1 class="h2 mb-3">Analyse des besoins de formation</h1>
                <p class="lead text-muted">
                    Entreprise : <strong>{{ request.companyName ?? request.recipientName }}</strong>
                </p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Ce formulaire nous permet d'adapter notre formation à vos besoins spécifiques.
                    Toutes les informations sont confidentielles et utilisées uniquement dans le cadre de votre projet de formation.
                </div>
            </div>

            {% if existing_analysis %}
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Formulaire déjà complété</strong><br>
                    Vous avez déjà rempli ce formulaire le {{ existing_analysis.createdAt|date('d/m/Y à H:i') }}.
                    Vous pouvez le modifier en remplissant à nouveau les champs ci-dessous.
                </div>
            {% endif %}

            <!-- Form -->
            <div class="card shadow">
                <div class="card-body p-4">
                    {{ form_start(form, {'attr': {'class': 'company-needs-form'}}) }}
                    
                    <!-- Company Information Section -->
                    <div class="mb-5">
                        <h3 class="h4 mb-4 text-primary">
                            <i class="fas fa-building me-2"></i>
                            Informations sur l'entreprise
                        </h3>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form_label(form.company_name) }}
                                    {{ form_widget(form.company_name) }}
                                    {{ form_help(form.company_name) }}
                                    {{ form_errors(form.company_name) }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form_label(form.responsible_person) }}
                                    {{ form_widget(form.responsible_person) }}
                                    {{ form_help(form.responsible_person) }}
                                    {{ form_errors(form.responsible_person) }}
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form_label(form.contact_email) }}
                                    {{ form_widget(form.contact_email) }}
                                    {{ form_help(form.contact_email) }}
                                    {{ form_errors(form.contact_email) }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form_label(form.contact_phone) }}
                                    {{ form_widget(form.contact_phone) }}
                                    {{ form_help(form.contact_phone) }}
                                    {{ form_errors(form.contact_phone) }}
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            {{ form_label(form.company_address) }}
                            {{ form_widget(form.company_address) }}
                            {{ form_help(form.company_address) }}
                            {{ form_errors(form.company_address) }}
                        </div>
                    </div>

                    <!-- Company Details Section -->
                    <div class="mb-5">
                        <h3 class="h4 mb-4 text-primary">
                            <i class="fas fa-chart-bar me-2"></i>
                            Détails de l'entreprise
                        </h3>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form_label(form.activity_sector) }}
                                    {{ form_widget(form.activity_sector) }}
                                    {{ form_help(form.activity_sector) }}
                                    {{ form_errors(form.activity_sector) }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form_label(form.employee_count) }}
                                    {{ form_widget(form.employee_count) }}
                                    {{ form_help(form.employee_count) }}
                                    {{ form_errors(form.employee_count) }}
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form_label(form.naf_code) }}
                                    {{ form_widget(form.naf_code) }}
                                    {{ form_help(form.naf_code) }}
                                    {{ form_errors(form.naf_code) }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form_label(form.siret) }}
                                    {{ form_widget(form.siret) }}
                                    {{ form_help(form.siret) }}
                                    {{ form_errors(form.siret) }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form_label(form.opco) }}
                                    {{ form_widget(form.opco) }}
                                    {{ form_help(form.opco) }}
                                    {{ form_errors(form.opco) }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Training Information Section -->
                    <div class="mb-5">
                        <h3 class="h4 mb-4 text-primary">
                            <i class="fas fa-graduation-cap me-2"></i>
                            Informations sur la formation
                        </h3>
                        <div class="mb-3">
                            {{ form_label(form.training_title) }}
                            {{ form_widget(form.training_title) }}
                            {{ form_help(form.training_title) }}
                            {{ form_errors(form.training_title) }}
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form_label(form.training_duration_hours) }}
                                    {{ form_widget(form.training_duration_hours) }}
                                    {{ form_help(form.training_duration_hours) }}
                                    {{ form_errors(form.training_duration_hours) }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form_label(form.preferred_start_date) }}
                                    {{ form_widget(form.preferred_start_date) }}
                                    {{ form_help(form.preferred_start_date) }}
                                    {{ form_errors(form.preferred_start_date) }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form_label(form.preferred_end_date) }}
                                    {{ form_widget(form.preferred_end_date) }}
                                    {{ form_help(form.preferred_end_date) }}
                                    {{ form_errors(form.preferred_end_date) }}
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            {{ form_label(form.training_location_preference) }}
                            {{ form_widget(form.training_location_preference) }}
                            {{ form_help(form.training_location_preference) }}
                            {{ form_errors(form.training_location_preference) }}
                        </div>
                        <div class="mb-3">
                            {{ form_label(form.location_appropriation_needs) }}
                            {{ form_widget(form.location_appropriation_needs) }}
                            {{ form_help(form.location_appropriation_needs) }}
                            {{ form_errors(form.location_appropriation_needs) }}
                        </div>
                        <div class="mb-3">
                            {{ form_label(form.disability_accommodations) }}
                            {{ form_widget(form.disability_accommodations) }}
                            {{ form_help(form.disability_accommodations) }}
                            {{ form_errors(form.disability_accommodations) }}
                        </div>
                    </div>

                    <!-- Training Needs Section -->
                    <div class="mb-5">
                        <h3 class="h4 mb-4 text-primary">
                            <i class="fas fa-target me-2"></i>
                            Analyse des besoins
                        </h3>
                        <div class="mb-3">
                            {{ form_label(form.training_expectations) }}
                            {{ form_widget(form.training_expectations) }}
                            {{ form_help(form.training_expectations) }}
                            {{ form_errors(form.training_expectations) }}
                        </div>
                        <div class="mb-3">
                            {{ form_label(form.specific_needs) }}
                            {{ form_widget(form.specific_needs) }}
                            {{ form_help(form.specific_needs) }}
                            {{ form_errors(form.specific_needs) }}
                        </div>
                    </div>

                    <!-- Submit Section -->
                    <div class="text-center">
                        <div class="alert alert-light border">
                            <i class="fas fa-shield-alt me-2"></i>
                            <small class="text-muted">
                                En soumettant ce formulaire, vous acceptez que vos données soient utilisées 
                                par EPROFOS dans le cadre de votre projet de formation. 
                                Vos informations restent confidentielles.
                            </small>
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg px-5">
                            <i class="fas fa-paper-plane me-2"></i>
                            Envoyer l'analyse des besoins
                        </button>
                    </div>

                    {{ form_end(form) }}
                </div>
            </div>

            <!-- Footer -->
            <div class="text-center mt-4">
                <small class="text-muted">
                    <i class="fas fa-lock me-1"></i>
                    Formulaire sécurisé - EPROFOS (École professionnelle de formation spécialisée)
                </small>
            </div>
        </div>
    </div>
</div>

<style>
.company-needs-form .form-label {
    font-weight: 600;
    color: #495057;
}

.company-needs-form .form-control:focus,
.company-needs-form .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.company-needs-form .text-primary {
    color: #0d6efd !important;
}

.company-needs-form .alert {
    border-radius: 0.5rem;
}

/* Bootstrap validation styles */
.company-needs-form .is-invalid {
    border-color: #dc3545;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.company-needs-form .is-invalid:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

.company-needs-form .invalid-feedback {
    display: block;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: #dc3545;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('.company-needs-form');
    if (!form) return;

    // Enhanced client-side validation for better UX (in addition to server-side validation)
    const inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(function(input) {
        input.addEventListener('blur', function() {
            // Only add visual feedback for client-side validation
            // Server-side validation classes (.is-invalid) are preserved
            if (!input.classList.contains('is-invalid') && input.value.trim()) {
                input.classList.add('is-valid');
            }
        });
    });

    // Smooth scroll to first error on form submission
    form.addEventListener('submit', function(e) {
        setTimeout(function() {
            const firstError = form.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }
        }, 100);
    });
});
</script>
{% endblock %}