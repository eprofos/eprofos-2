{% extends 'student/base.html.twig' %}

{% block title %}{{ page_title }} - {{ parent() }}{% endblock %}

{% block body %}
{% set courseCompleted = false %}
{% if enrollment and enrollment.progress %}
    {% set courseProgress = enrollment.progress.courseProgress %}
    {% set courseCompleted = courseProgress[course.id] is defined and courseProgress[course.id].completed is defined and courseProgress[course.id].completed %}
{% endif %}

<div class="container-fluid" 
     data-controller="progress-tracking" 
     data-progress-tracking-content-id-value="{{ course.id }}"
     data-progress-tracking-content-type-value="course"
     data-progress-tracking-progress-url-value="{{ path('student_progress_update') }}"
     data-progress-tracking-stats-url-value="{{ path('student_progress_stats') }}"
     data-progress-tracking-formation-id-value="{{ formation ? formation.id : '' }}"
     data-progress-tracking-completed-value="{{ courseCompleted ? 'true' : 'false' }}">
    <div class="row">
        <div class="col-12">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{{ path('student_dashboard') }}">Tableau de bord</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{{ path('student_formation_index') }}">Formations</a>
                    </li>
                    {% if formation %}
                        <li class="breadcrumb-item">
                            <a href="{{ path('student_formation_view', {id: formation.id}) }}">{{ formation.title }}</a>
                        </li>
                    {% endif %}
                    {% if module %}
                        <li class="breadcrumb-item">
                            <a href="{{ path('student_module_view', {id: module.id}) }}">{{ module.title }}</a>
                        </li>
                    {% endif %}
                    {% if chapter %}
                        <li class="breadcrumb-item">
                            <a href="{{ path('student_chapter_view', {id: chapter.id}) }}">{{ chapter.title }}</a>
                        </li>
                    {% endif %}
                    <li class="breadcrumb-item active" aria-current="page">{{ course.title }}</li>
                </ol>
            </nav>

            <div class="row">
                <div class="col-lg-8">
                    <!-- Course Header -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body">
                            <h1 class="h3 mb-3">{{ course.title }}</h1>
                            
                            {% if course.description %}
                                <p class="text-muted mb-3">{{ course.description }}</p>
                            {% endif %}
                            
                            <!-- Course Metadata -->
                            <div class="row g-2 mb-3">
                                {% if course.durationMinutes %}
                                    <div class="col-auto">
                                        <span class="badge bg-primary">
                                            <i class="fas fa-clock me-1"></i>
                                            {{ course.formattedDuration }}
                                        </span>
                                    </div>
                                {% endif %}
                                {% if course.type %}
                                    <div class="col-auto">
                                        <span class="badge bg-info">
                                            <i class="fas fa-tag me-1"></i>
                                            {{ course.typeLabel|default(course.type) }}
                                        </span>
                                    </div>
                                {% endif %}
                                {% if course.orderIndex %}
                                    <div class="col-auto">
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-list-ol me-1"></i>
                                            Cours {{ course.orderIndex }}
                                        </span>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Learning Objectives -->
                    {% if course.learningObjectives %}
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-target me-2"></i>
                                    Objectifs d'apprentissage
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    {% for objective in course.learningObjectives %}
                                        <div class="col-md-6 mb-2">
                                            <div class="d-flex align-items-start">
                                                <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                                                <span>{{ objective }}</span>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Course Content -->
                    {% if course.content %}
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-book-open me-2"></i>
                                    Contenu du cours
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="content-text">
                                    {{ course.content|nl2br }}
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Activities Section -->
                    {% if course.exercises|length > 0 or course.qcms|length > 0 %}
                        <div class="card border-0 shadow-sm">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-tasks me-2"></i>
                                    Activités et évaluations
                                </h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="list-group list-group-flush">
                                    <!-- Exercises -->
                                    {% for exercise in course.exercises %}
                                        <div class="list-group-item">
                                            <div class="row align-items-center">
                                                <div class="col-lg-8">
                                                    <div class="d-flex align-items-start">
                                                        <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                                                             style="width: 32px; height: 32px; flex-shrink: 0;">
                                                            <i class="fas fa-pencil-alt fa-sm"></i>
                                                        </div>
                                                        <div class="flex-grow-1">
                                                            <h6 class="mb-1">{{ exercise.title }}</h6>
                                                            {% if exercise.description %}
                                                                <p class="text-muted small mb-0">{{ exercise.description }}</p>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-lg-4 text-lg-end">
                                                    <a href="{{ path('student_exercise_view', {id: exercise.id}) }}" 
                                                       class="btn btn-outline-success btn-sm">
                                                        <i class="fas fa-pencil-alt me-1"></i>
                                                        Exercice
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}

                                    <!-- QCMs -->
                                    {% for qcm in course.qcms %}
                                        <div class="list-group-item">
                                            <div class="row align-items-center">
                                                <div class="col-lg-8">
                                                    <div class="d-flex align-items-start">
                                                        <div class="bg-warning text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                                                             style="width: 32px; height: 32px; flex-shrink: 0;">
                                                            <i class="fas fa-question fa-sm"></i>
                                                        </div>
                                                        <div class="flex-grow-1">
                                                            <h6 class="mb-1">{{ qcm.title }}</h6>
                                                            {% if qcm.description %}
                                                                <p class="text-muted small mb-1">{{ qcm.description }}</p>
                                                            {% endif %}
                                                            <div class="small text-muted">
                                                                {% if qcm.questions|length > 0 %}
                                                                    <i class="fas fa-list me-1"></i>
                                                                    {{ qcm.questions|length }} question{{ qcm.questions|length > 1 ? 's' : '' }}
                                                                {% endif %}
                                                                {% if qcm.timeLimitMinutes %}
                                                                    <i class="fas fa-clock ms-3 me-1"></i>
                                                                    {{ qcm.timeLimitMinutes }} min
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-lg-4 text-lg-end">
                                                    <a href="{{ path('student_qcm_view', {id: qcm.id}) }}" 
                                                       class="btn btn-outline-warning btn-sm">
                                                        <i class="fas fa-question me-1"></i>
                                                        QCM
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <div class="col-lg-4">
                    <!-- Course Navigation -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">Navigation</h6>
                        </div>
                        <div class="card-body">
                            {% if chapter and chapter.activeCourses|length > 1 %}
                                <div class="d-grid gap-2">
                                    {% set currentIndex = null %}
                                    {% for chapterCourse in chapter.activeCourses %}
                                        {% if chapterCourse.id == course.id %}
                                            {% set currentIndex = loop.index0 %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if currentIndex is not null and currentIndex > 0 %}
                                        {% set previousCourse = chapter.activeCourses[currentIndex - 1] %}
                                        <a href="{{ path('student_course_view', {id: previousCourse.id}) }}" 
                                           class="btn btn-outline-secondary btn-sm"
                                           data-content-navigation-target="prevButton">
                                            <i class="fas fa-arrow-left me-1"></i>
                                            Cours précédent
                                        </a>
                                    {% endif %}
                                    
                                    {% if currentIndex is not null and currentIndex < (chapter.activeCourses|length - 1) %}
                                        {% set nextCourse = chapter.activeCourses[currentIndex + 1] %}
                                        <a href="{{ path('student_course_view', {id: nextCourse.id}) }}" 
                                           class="btn btn-primary btn-sm"
                                           data-content-navigation-target="nextButton">
                                            <i class="fas fa-arrow-right me-1"></i>
                                            Cours suivant
                                        </a>
                                    {% endif %}
                                </div>
                            {% endif %}
                            
                            <hr>
                            
                            <div class="d-grid gap-2">
                                {% if chapter %}
                                    <a href="{{ path('student_chapter_view', {id: chapter.id}) }}" 
                                       class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-book me-1"></i>
                                        Retour au chapitre
                                    </a>
                                {% endif %}
                                {% if module %}
                                    <a href="{{ path('student_module_view', {id: module.id}) }}" 
                                       class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-list me-1"></i>
                                        Voir le module
                                    </a>
                                {% endif %}
                                
                                <!-- Interactive Actions -->
                                <hr>
                                {% if courseCompleted %}
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <span class="text-success">Cours terminé</span>
                                    </div>
                                {% else %}
                                    <button type="button" 
                                            class="btn btn-outline-success btn-sm"
                                            data-action="click->progress-tracking#markComplete">
                                        <i class="fas fa-check me-1"></i>
                                        Marquer comme terminé
                                    </button>
                                {% endif %}
                                <button type="button" 
                                        class="btn btn-outline-warning btn-sm"
                                        data-action="click->progress-tracking#toggleBookmark">
                                    <i class="fas fa-bookmark me-1"></i>
                                    Ajouter aux favoris
                                </button>
                                <button type="button" 
                                        class="btn btn-outline-info btn-sm"
                                        data-action="click->progress-tracking#shareProgress">
                                    <i class="fas fa-share me-1"></i>
                                    Partager
                                </button>
                                <button type="button" 
                                        class="btn btn-outline-secondary btn-sm"
                                        data-action="click->progress-tracking#exportProgress">
                                    <i class="fas fa-download me-1"></i>
                                    Exporter progrès
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Progress Info -->
                    {% if enrollment and enrollment.progress %}
                        <div class="card border-0 shadow-sm">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-line me-1"></i>
                                    Progression
                                    <span data-progress-tracking-target="completionStatus" class="small text-muted ms-2">
                                        En cours...
                                    </span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Reading Progress -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between small mb-1">
                                        <span>Progression de lecture</span>
                                        <span>0%</span>
                                    </div>
                                    <div class="progress mb-2" style="height: 8px;">
                                        <div class="progress-bar bg-primary" 
                                             data-progress-tracking-target="progressBar"
                                             role="progressbar" 
                                             style="width: 0%" 
                                             aria-valuenow="0" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100"></div>
                                    </div>
                                </div>
                                
                                <!-- Time Tracking -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between small">
                                        <span><i class="fas fa-clock me-1"></i>Temps passé</span>
                                        <span data-progress-tracking-target="timeDisplay">0s</span>
                                    </div>
                                </div>
                                
                                <!-- Overall Formation Progress -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between small mb-1">
                                        <span>Formation complète</span>
                                        <span class="overall-progress-text">{{ enrollment.progress.completionPercentage|round }}%</span>
                                    </div>
                                    <div class="progress mb-2" style="height: 6px;">
                                        <div class="progress-bar overall-progress-bar bg-success" 
                                             role="progressbar" 
                                             style="width: {{ enrollment.progress.completionPercentage }}%" 
                                             aria-valuenow="{{ enrollment.progress.completionPercentage }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100"></div>
                                    </div>
                                </div>
                                
                                <!-- Engagement Score -->
                                <div class="text-center">
                                    <div class="small text-muted mb-1">Score d'engagement</div>
                                    <span class="badge engagement-score {{ enrollment.progress.engagementBadgeClass }}">
                                        {{ enrollment.progress.engagementScore }}%
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Milestones -->
                        <div class="card border-0 shadow-sm mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-trophy me-1"></i>
                                    Réussites
                                </h6>
                            </div>
                            <div class="card-body">
                                <div data-progress-tracking-target="milestoneContainer">
                                    <!-- Milestones will be loaded here -->
                                    <div class="text-center text-muted small">
                                        <i class="fas fa-spinner fa-spin me-1"></i>
                                        Chargement des réussites...
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
