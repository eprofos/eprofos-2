{% extends 'student/base.html.twig' %}

{% block title %}{{ page_title }} - {{ parent() }}{% endblock %}

{% block page_actions %}
    <div class="btn-list">
        <div class="dropdown">
            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <path d="M4 6a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12z"/>
                    <path d="M4 10h16"/>
                    <path d="M10 4v6"/>
                </svg>
                Période d'analyse
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="?period=week">Cette semaine</a></li>
                <li><a class="dropdown-item" href="?period=month">Ce mois</a></li>
                <li><a class="dropdown-item" href="?period=quarter">Ce trimestre</a></li>
                <li><a class="dropdown-item" href="?period=year">Cette année</a></li>
                <li><a class="dropdown-item" href="?period=all">Tout</a></li>
            </ul>
        </div>
        <a href="{{ path('student_dashboard') }}" class="btn btn-outline-secondary">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path d="M9 14l-4 -4l4 -4"/>
                <path d="M5 10h11a4 4 0 1 1 0 8h-1"/>
            </svg>
            Retour au tableau de bord
        </a>
    </div>
{% endblock %}

{% block body %}
    <div class="row row-deck row-cards">
        <!-- Overall Progress Card -->
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <div class="avatar avatar-lg bg-primary text-white">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M3 17l6 -6l4 4l8 -8"/>
                                    <path d="M14 7l3 0l0 3"/>
                                </svg>
                            </div>
                        </div>
                        <div class="col">
                            <h2 class="mb-1">{{ overall_progress }}% de progression globale</h2>
                            <p class="text-muted mb-2">
                                {% if overall_progress >= 80 %}
                                    Excellent travail ! Vous êtes sur la bonne voie pour terminer vos formations.
                                {% elseif overall_progress >= 60 %}
                                    Bonne progression ! Continuez vos efforts pour atteindre vos objectifs.
                                {% elseif overall_progress >= 40 %}
                                    Progression en cours. N'hésitez pas à consulter vos ressources d'apprentissage.
                                {% elseif overall_progress >= 20 %}
                                    Début de parcours. Prenez le temps de vous familiariser avec le contenu.
                                {% else %}
                                    Bienvenue ! Commencez par explorer vos formations disponibles.
                                {% endif %}
                            </p>
                            <div class="progress progress-lg">
                                <div class="progress-bar bg-{{ overall_progress >= 80 ? 'success' : (overall_progress >= 60 ? 'primary' : (overall_progress >= 40 ? 'warning' : 'danger')) }}" 
                                     style="width: {{ overall_progress }}%" 
                                     role="progressbar" 
                                     aria-valuenow="{{ overall_progress }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    <span class="visually-hidden">{{ overall_progress }}% terminé</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row row-deck row-cards mt-4">
        <!-- Study Statistics -->
        <div class="col-md-6 col-xl-3">
            <div class="card card-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <span class="bg-primary text-white avatar">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="9"/>
                                    <polyline points="12,6 12,12 16,14"/>
                                </svg>
                            </span>
                        </div>
                        <div class="col">
                            <div class="font-weight-medium">
                                {{ study_time_stats.total_hours ?? 0 }}h {{ study_time_stats.total_minutes ?? 0 }}min
                            </div>
                            <div class="text-muted">
                                Temps d'étude total
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-xl-3">
            <div class="card card-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <span class="bg-success text-white avatar">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M5 12l5 5l10 -10"/>
                                </svg>
                            </span>
                        </div>
                        <div class="col">
                            <div class="font-weight-medium">
                                {{ study_time_stats.completed_sessions ?? 0 }}
                            </div>
                            <div class="text-muted">
                                Sessions terminées
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-xl-3">
            <div class="card card-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <span class="bg-warning text-white avatar">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"/>
                                    <path d="M12 10m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0"/>
                                    <path d="M6.168 18.849a4 4 0 0 1 3.832 -2.849h4a4 4 0 0 1 3.834 2.855"/>
                                </svg>
                            </span>
                        </div>
                        <div class="col">
                            <div class="font-weight-medium">
                                {{ study_time_stats.streak_days ?? 0 }}
                            </div>
                            <div class="text-muted">
                                Jours consécutifs
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-xl-3">
            <div class="card card-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <span class="bg-info text-white avatar">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <circle cx="12" cy="12" r="9"/>
                                    <path d="M14.5 7.5l-3 3l2 2l-2 2l-3 -3"/>
                                </svg>
                            </span>
                        </div>
                        <div class="col">
                            <div class="font-weight-medium">
                                {{ study_time_stats.average_per_day ?? 0 }}min
                            </div>
                            <div class="text-muted">
                                Moyenne par jour
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row row-deck row-cards mt-4">
        <!-- Course Progress -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2"/>
                            <circle cx="12" cy="14" r="2"/>
                            <path d="M14 4l0 4l-6 0l0 -4"/>
                        </svg>
                        Progression par formation
                    </h3>
                </div>
                <div class="card-body">
                    {% if course_progress is not empty %}
                        <div class="space-y-4">
                            {% for course in course_progress %}
                                <div class="mb-4 p-3 border rounded">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <h5 class="mb-1">{{ course.title ?? 'Formation' }}</h5>
                                            <div class="text-muted small">{{ course.description ?? 'Formation en cours' }}</div>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-{{ course.progress >= 80 ? 'success' : (course.progress >= 60 ? 'primary' : (course.progress >= 40 ? 'warning' : 'danger')) }}">
                                                {{ course.progress ?? 0 }}%
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-{{ course.progress >= 80 ? 'success' : (course.progress >= 60 ? 'primary' : (course.progress >= 40 ? 'warning' : 'danger')) }}" 
                                             style="width: {{ course.progress ?? 0 }}%" 
                                             role="progressbar" 
                                             aria-valuenow="{{ course.progress ?? 0 }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                        </div>
                                    </div>
                                    
                                    <div class="row text-muted small">
                                        <div class="col-sm-4">
                                            <strong>Modules:</strong> {{ course.completed_modules ?? 0 }}/{{ course.total_modules ?? 0 }}
                                        </div>
                                        <div class="col-sm-4">
                                            <strong>Temps passé:</strong> {{ course.time_spent ?? '0h 0min' }}
                                        </div>
                                        <div class="col-sm-4">
                                            <strong>Dernière activité:</strong> {{ course.last_activity|date('d/m/Y') ?? 'Jamais' }}
                                        </div>
                                    </div>
                                    
                                    {% if course.modules is defined and course.modules is not empty %}
                                        <div class="mt-3">
                                            <h6 class="text-muted">Détail des modules:</h6>
                                            <div class="row g-2">
                                                {% for module in course.modules %}
                                                    <div class="col-md-6">
                                                        <div class="d-flex align-items-center">
                                                            <div class="avatar avatar-xs me-2 bg-{{ module.completed ? 'success' : (module.progress > 0 ? 'warning' : 'secondary') }}">
                                                                {% if module.completed %}
                                                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-xs" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                                        <path d="M5 12l5 5l10 -10"/>
                                                                    </svg>
                                                                {% else %}
                                                                    <div class="progress progress-xs">
                                                                        <div class="progress-bar" style="width: {{ module.progress ?? 0 }}%"></div>
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                            <div class="flex-fill small">
                                                                <div class="text-truncate">{{ module.title ?? 'Module' }}</div>
                                                                <div class="text-muted">{{ module.progress ?? 0 }}%</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty">
                            <div class="empty-img">
                                <img src="{{ asset('images/undraw_empty.svg') }}" height="128" alt="Aucune progression" onerror="this.style.display='none'">
                            </div>
                            <p class="empty-title">Aucune formation en cours</p>
                            <p class="empty-subtitle text-muted">
                                Inscrivez-vous à une formation pour commencer à suivre votre progression.
                            </p>
                            <div class="empty-action">
                                <a href="{{ path('student_courses') }}" class="btn btn-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                        <path d="M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2"/>
                                        <circle cx="12" cy="14" r="2"/>
                                        <path d="M14 4l0 4l-6 0l0 -4"/>
                                    </svg>
                                    Découvrir les formations
                                </a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Achievements & Analytics -->
        <div class="col-lg-4">
            <!-- Recent Achievements -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M12 3l8 4.5v9l-8 4.5l-8 -4.5v-9l8 -4.5"/>
                            <path d="M12 12l8 -4.5"/>
                            <path d="M12 12v9"/>
                            <path d="M12 12l-8 -4.5"/>
                        </svg>
                        Derniers accomplissements
                    </h3>
                </div>
                <div class="card-body">
                    {% if recent_achievements is not empty %}
                        <div class="list-group list-group-flush">
                            {% for achievement in recent_achievements %}
                                <div class="list-group-item d-flex align-items-center px-0">
                                    <div class="avatar avatar-sm me-3 bg-{{ achievement.type == 'completion' ? 'success' : (achievement.type == 'milestone' ? 'primary' : 'warning') }}">
                                        {% if achievement.type == 'completion' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <path d="M5 12l5 5l10 -10"/>
                                            </svg>
                                        {% elseif achievement.type == 'milestone' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <circle cx="12" cy="12" r="9"/>
                                                <path d="M14.5 7.5l-3 3l2 2l-2 2l-3 -3"/>
                                            </svg>
                                        {% else %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <path d="M12 3l8 4.5v9l-8 4.5l-8 -4.5v-9l8 -4.5"/>
                                                <path d="M12 12l8 -4.5"/>
                                                <path d="M12 12v9"/>
                                                <path d="M12 12l-8 -4.5"/>
                                            </svg>
                                        {% endif %}
                                    </div>
                                    <div class="flex-fill">
                                        <div class="fw-bold">{{ achievement.title ?? 'Accomplissement' }}</div>
                                        <div class="text-muted small">{{ achievement.description ?? 'Nouveau succès débloqué!' }}</div>
                                        <div class="text-muted small">{{ achievement.date|date('d/m/Y') ?? 'now'|date('d/m/Y') }}</div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg text-muted mb-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                <circle cx="12" cy="12" r="9"/>
                                <path d="M12 8v4"/>
                                <path d="M12 16h.01"/>
                            </svg>
                            <p class="text-muted">Aucun accomplissement pour le moment.</p>
                            <p class="text-muted small">Complétez des modules pour débloquer vos premiers succès!</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Learning Analytics -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M3 17l6 -6l4 4l8 -8"/>
                            <path d="M14 7l3 0l0 3"/>
                        </svg>
                        Analyse d'apprentissage
                    </h3>
                </div>
                <div class="card-body">
                    <div class="space-y-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">Niveau d'engagement</span>
                            <div class="d-flex align-items-center">
                                <div class="progress progress-sm me-2" style="width: 60px;">
                                    <div class="progress-bar bg-{{ study_time_stats.engagement_level >= 80 ? 'success' : (study_time_stats.engagement_level >= 60 ? 'primary' : 'warning') }}" 
                                         style="width: {{ study_time_stats.engagement_level ?? 75 }}%"></div>
                                </div>
                                <span class="fw-bold">{{ study_time_stats.engagement_level ?? 75 }}%</span>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">Régularité</span>
                            <div class="d-flex align-items-center">
                                <div class="progress progress-sm me-2" style="width: 60px;">
                                    <div class="progress-bar bg-{{ study_time_stats.consistency >= 80 ? 'success' : (study_time_stats.consistency >= 60 ? 'primary' : 'warning') }}" 
                                         style="width: {{ study_time_stats.consistency ?? 60 }}%"></div>
                                </div>
                                <span class="fw-bold">{{ study_time_stats.consistency ?? 60 }}%</span>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">Rétention</span>
                            <div class="d-flex align-items-center">
                                <div class="progress progress-sm me-2" style="width: 60px;">
                                    <div class="progress-bar bg-{{ study_time_stats.retention_rate >= 80 ? 'success' : (study_time_stats.retention_rate >= 60 ? 'primary' : 'warning') }}" 
                                         style="width: {{ study_time_stats.retention_rate ?? 85 }}%"></div>
                                </div>
                                <span class="fw-bold">{{ study_time_stats.retention_rate ?? 85 }}%</span>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="text-center">
                        <h4 class="mb-1">Score global</h4>
                        <div class="h1 text-{{ study_time_stats.global_score >= 80 ? 'success' : (study_time_stats.global_score >= 60 ? 'primary' : 'warning') }}">
                            {{ study_time_stats.global_score ?? 73 }}/100
                        </div>
                        <div class="text-muted">
                            {% set score = study_time_stats.global_score ?? 73 %}
                            {% if score >= 90 %}
                                Excellent niveau! Continuez ainsi.
                            {% elseif score >= 75 %}
                                Très bon niveau! Quelques améliorations possibles.
                            {% elseif score >= 60 %}
                                Bon niveau! Travaillez la régularité.
                            {% elseif score >= 40 %}
                                Niveau satisfaisant. Augmentez votre engagement.
                            {% else %}
                                Début de parcours. Prenez votre temps.
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Weekly Study Time Chart -->
    {% if study_time_stats.weekly_data is defined and study_time_stats.weekly_data is not empty %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                <path d="M4 19l16 0"/>
                                <path d="M4 15l4 -6l4 2l4 -5l4 4"/>
                            </svg>
                            Temps d'étude hebdomadaire
                        </h3>
                    </div>
                    <div class="card-body">
                        <div id="study-time-chart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {% if study_time_stats.weekly_data is defined and study_time_stats.weekly_data is not empty %}
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const ctx = document.getElementById('study-time-chart');
                if (ctx) {
                    const chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: {{ study_time_stats.weekly_data.labels|json_encode|raw }},
                            datasets: [{
                                label: 'Temps d\'étude (minutes)',
                                data: {{ study_time_stats.weekly_data.values|json_encode|raw }},
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return value + ' min';
                                        }
                                    }
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const hours = Math.floor(context.parsed.y / 60);
                                            const minutes = context.parsed.y % 60;
                                            return `${hours}h ${minutes}min d'étude`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            });
        </script>
    {% endif %}
{% endblock %}
